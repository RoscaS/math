<!DOCTYPE html>
<html>

    <head>
        <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- CSS -->

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://localhost:4000/reseau/reseau-labo5.html">
  <link rel="alternate" type="application/rss+xml" title="RoscaS" href="http://localhost:4000/feed.xml">

<!-- JS -->
  <!-- <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script> -->
  <script src="/js/mermaid.min.js"></script>

</head>


        
          <script>
	  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
			  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    
  ga('create', 'UA-99742998-1', 'auto');
  ga('send', 'pageview');
    
	</script>


        

        
    </head>

    <body>
        <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Reseau: Labo 5 Programmation Sockets</title>
  <meta name="description" content="Labo 5: applications réseaux socket">
</head>


        <div class="wrapper">
            <header class="post-header">
	

    <center>
		<div class="post-title" itemprop="name headline">Reseau: Labo 5 Programmation Sockets</div>

		<div class="post-meta"><i class="fa fa-calendar-o"></i> <time datetime="21 May 2017" itemprop="datePublished">May 21 2017</time>

			&nbsp;&nbsp;•&nbsp;&nbsp;<i class="fa fa-user-secret"></i> <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Sol</span>
        	
			<br>
			<i class="fa fa-eye"></i> <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-pulse"></i></span>clicks</span>
		</div>

        	
        <div class="post-tags">
        	
			<a class="post-tags-item" href="http://localhost:4000/tags/">reseau</a>
        	
			<a class="post-tags-item" href="http://localhost:4000/tags/">labo</a>
        	
			<a class="post-tags-item" href="http://localhost:4000/tags/">couche4</a>
        	
			<a class="post-tags-item" href="http://localhost:4000/tags/">tcp</a>
        	
			<a class="post-tags-item" href="http://localhost:4000/tags/">udp</a>
        	
			<a class="post-tags-item" href="http://localhost:4000/tags/">fr</a>
        	
			
		</div>
    </center>

<div class="wrapper">

    <center>      
		<p>
			<a class="link" href="/">Home</a> /
			<a class="link" href="/archive/">Archive</a> /
			<a class="link" href="/category/">Category</a> / 
			<a class="link" href="/tags/">Tags</a> / 
			<a class="link" href="/about/">About</a> /
			<a class="link" href="/contact/">Contact</a>
    	</p>
    </center>
</div>
    
</header>

<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
<div class="post-content">
    <center>
	
	<p>labo 5: Application réseaux et sockets</p>
	
    </center>
	<h2>Directory</h2>
</div>

<div id="category"></div>

<div class="post-content" itemprop="articleBody">
    <h1 id="labo-5-applications-réseaux-socket">Labo 5: applications réseaux socket</h1>

<h2 id="1-makefile">1. Makefile</h2>

<h4 id="vérification-de-la-présence-de-make">vérification de la présence de <code class="highlighter-rouge">make</code></h4>

<div class="language-sh highlighter-rouge"><pre class="highlight"><code><span class="gp">sol@debian:~/LABOS/labo5$ </span>which make
/usr/bin/make+

</code></pre>
</div>

<h4 id="sassurer-que-cest-gnu-make">s’assurer que c’est GNU make:</h4>

<div class="language-sh highlighter-rouge"><pre class="highlight"><code><span class="gp">sol@debian:~/LABOS/labo5$ </span>dpkg -s make | grep GNU
 GNU Make is a utility which controls the generation of executables
</code></pre>
</div>

<h4 id="affichage-du-contenu-de-makefile">affichage du contenu de Makefile</h4>

<div class="language-makefile highlighter-rouge"><pre class="highlight"><code><span class="nl">sol@debian</span><span class="o">:</span><span class="nf">~/LABOS/labo5/makefile$ cat --show-tabs Makefile </span>

<span class="nv">DEST_IMAGES</span><span class="o">=</span>neuchatel.jpeg jura.jpeg

<span class="nl">all</span><span class="o">:</span> <span class="nf">$(DEST_IMAGES)</span>
<span class="err">^Ifile</span> <span class="err">*.jpeg</span>

<span class="nl">clean</span><span class="o">:</span>
<span class="err">^Irm</span> <span class="err">-f</span> <span class="err">$(DEST_IMAGES)</span>

<span class="nl">neuchatel.jpeg</span><span class="o">:</span> <span class="nf">neuchatel.png</span>
<span class="err">^Ipngtopnm</span> <span class="err">&lt;</span> <span class="err">$&lt;</span> <span class="err">|</span> <span class="err">pnmtojpeg</span> <span class="err">&gt;</span> <span class="err">$@</span>
<span class="err">^I@</span><span class="c"># n'oubliez pas le TAB � gauche!
</span><span class="err">^I@echo</span> <span class="err">converti</span> <span class="err">$&lt;</span> <span class="err">en</span> <span class="err">$@</span>

<span class="nl">jura.jpeg</span><span class="o">:</span> <span class="nf">jura.png</span>
<span class="err">^Ipngtopnm</span> <span class="err">&lt;</span> <span class="err">$&lt;</span> <span class="err">|</span> <span class="err">pnmtojpeg</span> <span class="err">&gt;</span> <span class="err">$@</span>
<span class="err">^I@</span><span class="c"># n'oubliez pas le TAB � gauche!
</span><span class="err">^I@echo</span> <span class="err">converti</span> <span class="err">$&lt;</span> <span class="err">en</span> <span class="err">$@</span>
</code></pre>
</div>

<h4 id="jeu-de-char-de-makefille">jeu de char de Makefille</h4>

<div class="language-sh highlighter-rouge"><pre class="highlight"><code><span class="gp">sol@debian:~/LABOS/labo5/makefile$ </span>file -i Makefile
Makefile: text/x-makefile; <span class="nv">charset</span><span class="o">=</span>iso-8859-1
</code></pre>
</div>

<h4 id="rencodage-de-makefille">rencodage de Makefille</h4>

<div class="language-sh highlighter-rouge"><pre class="highlight"><code><span class="gp">sol@debian:~/LABOS/labo5/makefile$ </span>recode iso-8859-1..UTF-8 Makefile 
<span class="gp">sol@debian:~/LABOS/labo5/makefile$ </span>file -i Makefile
Makefile: text/x-makefile; <span class="nv">charset</span><span class="o">=</span>utf-8
</code></pre>
</div>

<div class="language-makefile highlighter-rouge"><pre class="highlight"><code><span class="nl">sol@debian</span><span class="o">:</span><span class="nf">~/LABOS/labo5/makefile$ cat --show-tabs Makefile </span>
<span class="nv">DEST_IMAGES</span><span class="o">=</span>neuchatel.jpeg jura.jpeg

<span class="nl">all</span><span class="o">:</span> <span class="nf">$(DEST_IMAGES)</span>
<span class="err">^Ifile</span> <span class="err">*.jpeg</span>

<span class="nl">clean</span><span class="o">:</span>
<span class="err">^Irm</span> <span class="err">-f</span> <span class="err">$(DEST_IMAGES)</span>

<span class="nl">neuchatel.jpeg</span><span class="o">:</span> <span class="nf">neuchatel.png</span>
<span class="err">^Ipngtopnm</span> <span class="err">&lt;</span> <span class="err">$&lt;</span> <span class="err">|</span> <span class="err">pnmtojpeg</span> <span class="err">&gt;</span> <span class="err">$@</span>
<span class="err">^I@</span><span class="c"># n'oubliez pas le TAB à gauche!
</span><span class="err">^I@echo</span> <span class="err">converti</span> <span class="err">$&lt;</span> <span class="err">en</span> <span class="err">$@</span>

<span class="nl">jura.jpeg</span><span class="o">:</span> <span class="nf">jura.png</span>
<span class="err">^Ipngtopnm</span> <span class="err">&lt;</span> <span class="err">$&lt;</span> <span class="err">|</span> <span class="err">pnmtojpeg</span> <span class="err">&gt;</span> <span class="err">$@</span>
<span class="err">^I@</span><span class="c"># n'oubliez pas le TAB à gauche!
</span><span class="err">^I@echo</span> <span class="err">converti</span> <span class="err">$&lt;</span> <span class="err">en</span> <span class="err">$@</span>
</code></pre>
</div>

<p>L’option <code class="highlighter-rouge">--show-tabs</code> remplace les tabulations par des <code class="highlighter-rouge">^</code></p>

<h3 id="question-6">question 6</h3>

<p>tuto <a href="/Cpp/makefile.html">makefile</a></p>

<div class="language-makefile highlighter-rouge"><pre class="highlight"><code><span class="nl">cible</span><span class="o">:</span> <span class="nf">dependance</span>
    <span class="err">commandes</span>

<span class="err">$@</span>  <span class="c"># nom de la cible actuelle.
</span></code></pre>
</div>

<p>Le Makefille va réencoder les fichier <code class="highlighter-rouge">neuchatel.png</code> et <code class="highlighter-rouge">jura.png</code> en <code class="highlighter-rouge">neuchatel.jpg</code> et <code class="highlighter-rouge">jura.jpg</code></p>

<h3 id="question-7">question 7</h3>

<div class="language-makefile highlighter-rouge"><pre class="highlight"><code><span class="nl">fichier1.txt</span><span class="o">:</span> <span class="nf">fichier0.txt</span>
    <span class="err">cat</span> <span class="err">fichier0.txt</span> <span class="err">&gt;</span> <span class="err">fichier1.txt</span>
</code></pre>
</div>

<p>Cette règle ne sera exécutée que si fichier0.txt est plus récent que fichier1.txt</p>

<p>Dans notre cas:</p>

<div class="language-makefile highlighter-rouge"><pre class="highlight"><code><span class="nl">neuchatel.jpeg</span><span class="o">:</span> <span class="nf">neuchatel.png</span>
	pngtopnm &lt; <span class="nv">$&lt;</span> | pnmtojpeg &gt; <span class="nv">$@</span>
	<span class="p">@</span><span class="c"># n'oubliez pas le TAB à gauche!</span>
	<span class="p">@</span><span class="nb">echo </span>converti <span class="nv">$&lt;</span> en <span class="nv">$@</span>
</code></pre>
</div>

<p>La règle n’est pas exécutée car neuchatel.png n’est pas plus récent que neuchatel.jpg et pareil pour jura.png.</p>

<h3 id="question-8">question 8</h3>

<div class="language-sh highlighter-rouge"><pre class="highlight"><code><span class="gp">sol@debian:~/LABOS/labo5/makefile$ </span>touch jura.png
<span class="gp">sol@debian:~/LABOS/labo5/makefile$ </span>make 
pngtopnm &lt; jura.png | pnmtojpeg &gt; jura.jpeg
converti jura.png en jura.jpeg
file <span class="k">*</span>.jpeg
jura.jpeg:      JPEG image data, JFIF standard 1.01, aspect ratio, density 1x1, segment length 16, baseline, precision 8, 406x493, frames 3
neuchatel.jpeg: JPEG image data, JFIF standard 1.01, aspect ratio, density 1x1, segment length 16, baseline, precision 8, 406x493, frames 3
</code></pre>
</div>

<p>Comme <code class="highlighter-rouge">touch jura.png</code> modifie la date de modification de jura.png, il devient donc plus récent que jura.jpeg et la règle…</p>

<div class="language-makefile highlighter-rouge"><pre class="highlight"><code><span class="nl">jura.jpeg</span><span class="o">:</span> <span class="nf">jura.png</span>
	pngtopnm &lt; <span class="nv">$&lt;</span> | pnmtojpeg &gt; <span class="nv">$@</span>
</code></pre>
</div>

<p>… est denouveau valable.</p>

<h3 id="question-9">question 9</h3>

<p><code class="highlighter-rouge">@</code> empêche l’affichage de la sortie texte d’une commande.</p>

<h3 id="question-10">question 10</h3>

<p>En utilisant le <strong>Pattern matching</strong> on peut créer des règles génériques pour entre autres convertir les fichiers d’un certain format en un autre:</p>

<blockquote>
  <p>Make exécute une règle même si le fichier correspondant est situé dans un sous dossier ! En cas de conflit, la règle avec la meilleure correspondance est choisie.</p>
</blockquote>

<p>La syntaxe générale d’une fonction:</p>
<div class="language-makefile highlighter-rouge"><pre class="highlight"><code><span class="err">$(fonction</span> <span class="err">arg0,arg1,arg2...).</span>
</code></pre>
</div>

<p>La fonction <code class="highlighter-rouge">patsubst</code> remplace par une paterne chaque mot dans une liste donnée.</p>

<p>Normalement les remplacement de Wildcards se font automatiquement dans les règles mais comme dans notre cas on veut utiliser un wildcard en argument d’une fonction on doit utiliser la fonction <code class="highlighter-rouge">wildcard</code>.</p>

<p>syntaxe:</p>
<div class="language-makefile highlighter-rouge"><pre class="highlight"><code><span class="err">$(patsubst</span> <span class="err">%.c,%.o,$(wildcard</span> <span class="err">*.c))</span>
</code></pre>
</div>

<p>Élimination de la redondance dans le Makefile original + optimisation via fonctions.</p>

<div class="language-makefile highlighter-rouge"><pre class="highlight"><code><span class="nv">DEST_IMAGES</span><span class="o">=</span><span class="err">$</span><span class="o">(</span>patsubst %.png, %.jpeg, <span class="err">$</span><span class="o">(</span>wildcard <span class="k">*</span>.png<span class="o">))</span>

<span class="nl">all</span><span class="o">:</span> <span class="nf">$(DEST_IMAgES)</span>
	file <span class="k">*</span>.jpeg

<span class="nl">%.jpeg</span><span class="o">:</span> <span class="nf">%.png</span>
	pngtopnm &lt; <span class="nv">$&lt;</span> | pnmtojpeg &gt; <span class="nv">$@</span>
	<span class="p">@</span><span class="nb">echo </span>converti <span class="nv">$&lt;</span> en <span class="nv">$@</span>

<span class="nl">clean</span><span class="o">:</span>
	rm -f <span class="nv">$(DEST_IMAGES)</span>
</code></pre>
</div>

<p>sources:<br />
<a href="https://www.gnu.org/software/make/manual/html_node/Wildcard-Function.html">gnu.org</a><br />
<a href="https://stackoverflow.com/questions/33740270/makefile-patsubst-multiple-expressions">stackoverflow.com</a><br />
<a href="https://learnxinyminutes.com/docs/make/">learnxinyminutes.com</a></p>

<h3 id="question-11">question 11</h3>
<h4 id="a">a.</h4>
<div class="language-sh highlighter-rouge"><pre class="highlight"><code><span class="gp">sol@debian:~/LABOS/labo5/02tests$ </span>make a.o
cc    -c -o a.o a.c
<span class="gp">sol@debian:~/LABOS/labo5/02tests$ </span>ls
a.c  a.o
</code></pre>
</div>

<p>Si on utilise le <code class="highlighter-rouge">-d</code> de make on a tout un paquet d’informations mais dans les premières lignes on peut voir que c’est bien GCC qui est utilisé pour le build.</p>

<div class="language-sh highlighter-rouge"><pre class="highlight"><code><span class="gp">sol@debian:~/LABOS/labo5/02tests$ </span>make -d a.o
GNU Make 4.0
Built <span class="k">for </span>x86_64-pc-linux-gnu
<span class="c"># ...</span>
Finished prerequisites of target file <span class="s1">'a.o'</span>.
Must remake target <span class="s1">'a.o'</span>.
cc    -c -o a.o a.c
Putting child 0x10dfde0 <span class="o">(</span>a.o<span class="o">)</span> PID 6042 on the chain.
Live child 0x10dfde0 <span class="o">(</span>a.o<span class="o">)</span> PID 6042 
Reaping winning child 0x10dfde0 PID 6042 
Removing child 0x10dfde0 PID 6042 from chain.
Successfully remade target file <span class="s1">'a.o'</span>.
<span class="gp">sol@debian:~/LABOS/labo5/02tests$ </span>ls
a.c  a.o
</code></pre>
</div>

<h4 id="b">b.</h4>

<p><code class="highlighter-rouge">CFLAGS</code> et <code class="highlighter-rouge">CXXFLAGS</code> sont les noms de variables d’environnement ou de variables du Makefile qui peuvent être utilisées pour paramétrer la compilation d’un logiciel.</p>

<p>Ces variables sont habituellement positionnées dans un Makefile et sont ajoutées quand le compilateur est appelé. Si elles ne sont pas spécifiées dans le Makefile, alors elles seront prises directement à partir de l’environnement, si elles sont présentes.</p>

<p><code class="highlighter-rouge">CFLAGS</code> permet d’ajouter des paramètres sur la ligne de commande qui appelle le compilateur C, alors que <code class="highlighter-rouge">CXXFLAGS</code> est utilisé pour la compilation <strong>C++</strong>. De même, une variable similaire, <code class="highlighter-rouge">CPPFLAGS</code>, permet de passer des paramètres <strong>sur la ligne de commande du Préprocesseur C</strong>.</p>

<ul>
  <li>
    <p><strong>-Wall : -W represents warnings. -Wall means it will show all possible warnings.</strong></p>
  </li>
  <li>
    <p>-O2 : means optimize it. These are used in creating machine code from source code by compiler. There are many levels of optimizing. O2 is generally considered good enough, while O3 makes your file size bigger without optimizing significantly, and may make your program slower on some sort of algorithms.</p>
  </li>
  <li>
    <p>-g means debug. This will add many debugging “notes” in your final binary, so that when you run a debugger on your final binary file, the debugger will know what part of this binary file is related to which part of the original source code.</p>
  </li>
  <li>
    <p>-I/path/to/include/files : In C/C++, you can include files which compiler already knows where they are present with command: #include <filename.h>. If the compiler does not know where the include file you want to include is present, you can specify the path to that directory with -I/the/directory</filename.h></p>
  </li>
</ul>

<p>Il nous faut donc créer un Makefile et y ajouter une ligne <code class="highlighter-rouge">CFLAGS=-Wall</code></p>

<div class="language-sh highlighter-rouge"><pre class="highlight"><code><span class="gp">sol@debian:~/LABOS/labo5/02tests$ </span>make -Wall a.o
cc -Wall   -c -o a.o a.c
<span class="gp">sol@debian:~/LABOS/labo5/02tests$ </span>rm a.0
<span class="gp">sol@debian:~/LABOS/labo5/02tests$ </span>make a.o
cc -Wall   -c -o a.o a.c
</code></pre>
</div>

<p>sources:<br />
<a href="https://linux.die.net/man/1/gcc">man gcc</a><br />
<a href="https://fr.wikipedia.org/wiki/CFLAGS">wikipedia.fr</a><br />
<a href="http://www.cs.colby.edu/maxwell/courses/tutorials/maketutor/">cs.colby.edu</a><br />
<a href="https://wiki.gentoo.org/wiki/GCC_optimization">wiki.gentoo.org</a>  (très bon site) qui explique ce point en détails</p>

<h3 id="question-12">question 12</h3>

<p>Voir question 10</p>

<h3 id="question-13">question 13</h3>

<p>voir question 10</p>

<h2 id="2-traçage-et-simulation">2. Traçage et simulation</h2>

<ul>
  <li><code class="highlighter-rouge">netstat -an</code>         <em>voir tous les sockets</em></li>
  <li><code class="highlighter-rouge">netstat -an --inet</code>  <em>sockets ipv4</em></li>
  <li><code class="highlighter-rouge">netstat -an --inet6</code> <em>sockets ipv6</em></li>
  <li><code class="highlighter-rouge">netstat --inet --listen -NNNN</code> <em>socket en écoute</em></li>
  <li><code class="highlighter-rouge">netstat --inet6 --listen -NNNN</code> <em>socket en écoute</em></li>
  <li><strong>sudo</strong> <code class="highlighter-rouge">netstat</code> <code class="highlighter-rouge">-p</code> …  <em>identification du process lié (PID/prgrm name)</em>
    <blockquote>
      <p><code class="highlighter-rouge">a</code> <em>display all sockets</em><br />
<code class="highlighter-rouge">n</code> <em>numeric: don’t resolve name</em></p>
    </blockquote>
  </li>
  <li><code class="highlighter-rouge">strace</code> <em>traçage des appels system</em>
    <blockquote>
      <p><code class="highlighter-rouge">-e</code> <strong>expr</strong> <em>a qualifying expression: option=[!]all or option=[!]val1[,val2]…</em></p>
      <div class="language-sh highlighter-rouge"><pre class="highlight"><code>strace -e socket,connect ./simple-client localhost 7000
</code></pre>
      </div>
    </blockquote>
  </li>
  <li><code class="highlighter-rouge">ltrace</code> <em>traçage des fonctions de la LIBC</em></li>
</ul>

<p><em>création d’un serveur TCP avec netcat:</em></p>
<ul>
  <li><code class="highlighter-rouge">nc -l -p</code> port
    <blockquote>
      <p><code class="highlighter-rouge">nc</code>   <em>netcat</em><br />
<code class="highlighter-rouge">-l</code>   <em>listen mode, for inbound connects</em><br />
<code class="highlighter-rouge">-p</code>   <em>local port number</em></p>
    </blockquote>
  </li>
</ul>

<p><span style="color:#F92672"><strong>penser à utiliser Wireshark !</strong></span></p>

<h3 id="question-1">question 1</h3>

<p>Afficher les permissions:</p>

<div class="language-sh highlighter-rouge"><pre class="highlight"><code>-rwxr-xr-x 1 sol sol 10995 Mar 25  2015 a-tracer
</code></pre>
</div>

<h3 id="question-2">question 2</h3>

<p>Lancer et déterminer le PID</p>

<div class="language-sh highlighter-rouge"><pre class="highlight"><code><span class="gp">sol@debian:~/LABOS/labo5/03Trace$ </span>./a-tracer &amp;
<span class="o">[</span>1] 6834
</code></pre>
</div>

<h3 id="question-3">question 3</h3>

<p>Déterminer les ports en écoute</p>

<div class="language-sh highlighter-rouge"><pre class="highlight"><code><span class="gp">sol@debian:~$ </span>sudo netstat -p -n --inet --listen 6834
Active Internet connections <span class="o">(</span>only servers<span class="o">)</span>
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        0      0 0.0.0.0:22              0.0.0.0:<span class="k">*</span>               LISTEN      453/sshd        
tcp        0      0 0.0.0.0:12345           0.0.0.0:<span class="k">*</span>               LISTEN      6834/a-tracer   
tcp        0      0 127.0.0.1:25            0.0.0.0:<span class="k">*</span>               LISTEN      844/exim4       
udp        0      0 0.0.0.0:59362           0.0.0.0:<span class="k">*</span>                           828/dhclient    
udp        0      0 0.0.0.0:68              0.0.0.0:<span class="k">*</span>                           828/dhclient    
udp        0      0 10.0.2.15:123           0.0.0.0:<span class="k">*</span>                           498/ntpd        
udp        0      0 127.0.0.1:123           0.0.0.0:<span class="k">*</span>                           498/ntpd        
udp        0      0 0.0.0.0:123             0.0.0.0:<span class="k">*</span>                           498/ntpd        
</code></pre>
</div>

<p>L’option <code class="highlighter-rouge">-n</code> permet de ne pas résoudre les noms.<br />
Notre application utilise donc le port <strong>12345</strong>.</p>

<h3 id="question-4">question 4</h3>

<p>Après un kill du process…</p>

<div class="language-sh highlighter-rouge"><pre class="highlight"><code><span class="gp">sol@debian:~$ </span>sudo netstat -p -n --inet --listen 6834
Active Internet connections <span class="o">(</span>only servers<span class="o">)</span>
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        0      0 0.0.0.0:22              0.0.0.0:<span class="k">*</span>               LISTEN      453/sshd        
tcp        0      0 127.0.0.1:25            0.0.0.0:<span class="k">*</span>               LISTEN      844/exim4       
udp        0      0 0.0.0.0:59362           0.0.0.0:<span class="k">*</span>                           828/dhclient    
udp        0      0 0.0.0.0:68              0.0.0.0:<span class="k">*</span>                           828/dhclient    
udp        0      0 10.0.2.15:123           0.0.0.0:<span class="k">*</span>                           498/ntpd        
udp        0      0 127.0.0.1:123           0.0.0.0:<span class="k">*</span>                           498/ntpd        
udp        0      0 0.0.0.0:123             0.0.0.0:<span class="k">*</span>                           498/ntpd  
</code></pre>
</div>

<p>GONE !</p>

<h3 id="question-5">question 5</h3>

<h4 id="a-1">a.</h4>

<p>Dans le cycle de vie des sockets d’un serveur TCP nous retrouvons les fonctions socket() bind() listen() et accept() qui sont utilisées avant l’établissement de la connexion.</p>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="c1">///...
</span><span class="n">socket</span>      <span class="p">(</span><span class="n">PF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="n">IPPROTO_IP</span><span class="p">)</span>      <span class="o">=</span> <span class="mi">3</span>
<span class="n">setsockopt</span>  <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">4</span><span class="p">)</span>   <span class="o">=</span> <span class="mi">0</span>
<span class="n">bind</span>        <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="p">{</span><span class="n">sa_family</span><span class="o">=</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">sin_port</span><span class="o">=</span><span class="n">htons</span><span class="p">(</span><span class="mi">12345</span><span class="p">),</span> <span class="n">sin_addr</span><span class="o">=</span><span class="n">inet_addr</span><span class="p">(</span><span class="s">"0.0.0.0"</span><span class="p">)},</span> <span class="mi">16</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">listen</span>      <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>                                  <span class="o">=</span> <span class="mi">0</span>
<span class="n">accept</span>      <span class="p">(</span><span class="mi">3</span><span class="p">,</span> 
</code></pre>
</div>

<p>Sur cette première capture des appels system nous retrouvons les fonctions nos fonctions:</p>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="kt">int</span> <span class="n">socket</span><span class="p">(</span><span class="kt">int</span> <span class="n">domain</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">protocol</span><span class="p">);</span>
</code></pre>
</div>
<p>Cette fonction crée un socket. On remarque qu’un socket est donc de type <strong>int</strong>.
Renvoie le descripteur du socket nouvellement créé.</p>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="kt">int</span> <span class="n">bind</span><span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">my_addr</span><span class="p">,</span> <span class="n">socklen_t</span> <span class="n">addrlen</span><span class="p">);</span>
</code></pre>
</div>
<p>Lie un socket avec une structure <code class="highlighter-rouge">sockaddr</code>.</p>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="kt">int</span> <span class="n">listen</span><span class="p">(</span><span class="kt">int</span> <span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">backlog</span><span class="p">);</span>
</code></pre>
</div>
<p>Définie la taille de la file de connexions en attente pour le socket <code class="highlighter-rouge">s</code>.</p>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="kt">int</span> <span class="n">accept</span><span class="p">(</span><span class="kt">int</span> <span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">adresse</span><span class="p">,</span> <span class="n">socklen_t</span> <span class="o">*</span><span class="n">longueur</span><span class="p">);</span>
</code></pre>
</div>
<p>Accepte la connexion d’un socket sur le socket <code class="highlighter-rouge">sock</code>. Le socket aura été préalablement lié avec un port avec la fonction <code class="highlighter-rouge">bind</code>
L’argument adresse sera remplie avec les informations du client qui s’est connecté.
Cette fonction retourne un nouveau socket, qui devra être utilisé pour communiquer avec le client.</p>

<p><strong>La dernière fonction est particulièrement révélatrice. C’est bien le cycle de vie d’un serveur TCP qui attend un qu’un client se connecte. D’où le fait que la capture de <code class="highlighter-rouge">strace</code> soie en stand by à cet endroit.</strong></p>

<p>sources<br />
<a href="http://broux.developpez.com/articles/c/sockets/">super tuto programmation sockets</a></p>

<h4 id="b-1">b.</h4>

<blockquote>
  <h5 id="cycle-de-vie-sockets-tcp">Cycle de vie sockets TCP</h5>

  <p>Il s’agit des appels système utilisés pour:</p>
  <ul>
    <li>créér des sockets</li>
    <li>les lier à un port connu</li>
    <li>accepter des connexions TCP</li>
  </ul>
</blockquote>

<p>Les étapes passées dans notre cas sont donc: création et bind</p>

<h4 id="c">c.</h4>

<p>acceptation (c’est la phase la plus hard et la plus longue d’une rupture)</p>

<h3 id="question-6-1">question 6</h3>

<p>Après la commande <code class="highlighter-rouge">nc localhost 12345</code> nous avons:</p>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="n">accept</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">Process</span> <span class="mi">7127</span> <span class="n">attached</span>
 <span class="o">&lt;</span><span class="n">unfinished</span> <span class="p">...</span><span class="o">&gt;</span>
<span class="p">[</span><span class="n">pid</span>  <span class="mi">7127</span><span class="p">]</span> <span class="n">close</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>                    <span class="o">=</span> <span class="mi">0</span>
<span class="p">[</span><span class="n">pid</span>  <span class="mi">7127</span><span class="p">]</span> <span class="n">fstat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="n">st_mode</span><span class="o">=</span><span class="n">S_IFCHR</span><span class="o">|</span><span class="mo">0620</span><span class="p">,</span> <span class="n">st_rdev</span><span class="o">=</span><span class="n">makedev</span><span class="p">(</span><span class="mi">136</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">...})</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">[</span><span class="n">pid</span>  <span class="mi">7127</span><span class="p">]</span> <span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span> <span class="n">PROT_READ</span><span class="o">|</span><span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_PRIVATE</span><span class="o">|</span><span class="n">MAP_ANONYMOUS</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x7fe86d900000</span>
<span class="p">[</span><span class="n">pid</span>  <span class="mi">7127</span><span class="p">]</span> <span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">"7127: new connection from client"</span><span class="p">...,</span> <span class="mi">547127</span><span class="o">:</span> <span class="n">new</span> <span class="n">connection</span> <span class="n">from</span> <span class="n">client</span> <span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span> <span class="n">port</span> <span class="mi">47530</span>
<span class="p">)</span> <span class="o">=</span> <span class="mi">54</span>
<span class="p">[</span><span class="n">pid</span>  <span class="mi">7127</span><span class="p">]</span> <span class="n">fcntl</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">F_GETFL</span><span class="p">)</span>           <span class="o">=</span> <span class="mh">0x2</span> <span class="p">(</span><span class="n">flags</span> <span class="n">O_RDWR</span><span class="p">)</span>
<span class="p">[</span><span class="n">pid</span>  <span class="mi">7127</span><span class="p">]</span> <span class="n">brk</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>                      <span class="o">=</span> <span class="mh">0x245a000</span>
<span class="p">[</span><span class="n">pid</span>  <span class="mi">7127</span><span class="p">]</span> <span class="n">brk</span><span class="p">(</span><span class="mh">0x247b000</span><span class="p">)</span>              <span class="o">=</span> <span class="mh">0x247b000</span>
<span class="p">[</span><span class="n">pid</span>  <span class="mi">7127</span><span class="p">]</span> <span class="n">fstat</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="p">{</span><span class="n">st_mode</span><span class="o">=</span><span class="n">S_IFSOCK</span><span class="o">|</span><span class="mo">0777</span><span class="p">,</span> <span class="n">st_size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="p">...})</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">[</span><span class="n">pid</span>  <span class="mi">7127</span><span class="p">]</span> <span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span> <span class="n">PROT_READ</span><span class="o">|</span><span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_PRIVATE</span><span class="o">|</span><span class="n">MAP_ANONYMOUS</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x7fe86d8ff000</span>
<span class="p">[</span><span class="n">pid</span>  <span class="mi">7127</span><span class="p">]</span> <span class="n">lseek</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SEEK_CUR</span><span class="p">)</span>       <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="n">ESPIPE</span> <span class="p">(</span><span class="n">Illegal</span> <span class="n">seek</span><span class="p">)</span>
<span class="p">[</span><span class="n">pid</span>  <span class="mi">7127</span><span class="p">]</span> <span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> 
</code></pre>
</div>

<h4 id="a-2">a.</h4>

<p>si nous reprenons l’explication de la fonction accept():</p>

<blockquote>
  <p>Accepte la connexion d’un socket sur le socket <code class="highlighter-rouge">sock</code>. Le socket aura été préalablement lié avec un port avec la fonction <code class="highlighter-rouge">bind</code>
L’argument adresse sera remplie avec les informations du client qui s’est connecté.
Cette fonction retourne un nouveau socket, qui devra être utilisé pour communiquer avec le client.</p>
</blockquote>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="n">accept</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">Process</span> <span class="mi">7127</span> <span class="n">attached</span>
</code></pre>
</div>
<p>nous dit donc que le le process avec le PID 7127  s’est <span style="color:#F92672"> connecté sur le socket 3. pas sur, (poser la question)  </span></p>

<p><code class="highlighter-rouge">ps -u</code> nous renvoie que le process 7127 est:</p>

<div class="language-sh highlighter-rouge"><pre class="highlight"><code>sol       7127  0.0  0.0   4220    80 pts/1    S+   18:01   0:00 ./a-tracer
</code></pre>
</div>

<h4 id="b-2">b.</h4>

<p>Ici nous voyons qu’une seconde instance de a-tracer est apparue ce qui colle avec l’explication de la fonction <code class="highlighter-rouge">accept()</code></p>

<div class="language-sh highlighter-rouge"><pre class="highlight"><code><span class="gp">sol@debian:~/LABOS/labo5/03Trace$ </span>sudo netstat -anp --inet
Active Internet connections <span class="o">(</span>servers and established<span class="o">)</span>
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        0      0 0.0.0.0:22              0.0.0.0:<span class="k">*</span>               LISTEN      453/sshd        
tcp        0      0 0.0.0.0:12345           0.0.0.0:<span class="k">*</span>               LISTEN      7125/a-tracer   
tcp        0      0 127.0.0.1:25            0.0.0.0:<span class="k">*</span>               LISTEN      844/exim4       
tcp        0      0 127.0.0.1:12345         127.0.0.1:47534         ESTABLISHED 7127/a-tracer   
tcp        0      0 127.0.0.1:12345         127.0.0.1:47533         TIME_WAIT   -               
tcp        0      0 127.0.0.1:47534         127.0.0.1:12345         ESTABLISHED 7126/nc         
udp        0      0 0.0.0.0:59362           0.0.0.0:<span class="k">*</span>                           828/dhclient    
udp        0      0 0.0.0.0:68              0.0.0.0:<span class="k">*</span>                           828/dhclient    
udp        0      0 10.0.2.15:123           0.0.0.0:<span class="k">*</span>                           498/ntpd        
udp        0      0 127.0.0.1:123           0.0.0.0:<span class="k">*</span>                           498/ntpd        
udp        0      0 0.0.0.0:123             0.0.0.0:<span class="k">*</span>                           498/ntpd    
</code></pre>
</div>

<h4 id="c-1">c.</h4>

<p>Encore une fois, grace à l’explication de la fonction <code class="highlighter-rouge">accept()</code> nous pouvons dire que le processus initial, est toujours en écoute alors que le process qu’elle a retourné s’est lié au socket 47534. Nous le voyons sur le <code class="highlighter-rouge">netstat -anp --inet</code> précédent.</p>

<p>et voilà la dernière ligne qui désigne le process de <code class="highlighter-rouge">netcat</code> propriétaire du socket 47534</p>

<div class="language-sh highlighter-rouge"><pre class="highlight"><code>tcp        0      0 127.0.0.1:47534         127.0.0.1:12345         ESTABLISHED 7126/nc  
</code></pre>
</div>

<h4 id="d">d.</h4>

<p>Il y a <code class="highlighter-rouge">n + 1</code> = 3 sockets.</p>

<p>a-tracer est donc un <strong>server</strong> <code class="highlighter-rouge">TCP</code> en mode <code class="highlighter-rouge">flux</code>.</p>

<h4 id="e">e.</h4>

<p><code class="highlighter-rouge">accept()</code></p>

<h4 id="f">f.</h4>

<p><code class="highlighter-rouge">-f -- follow forks</code></p>

<h4 id="g">g.</h4>

<p><code class="highlighter-rouge">-p pid -- trace process with process id PID, may be repeated</code></p>

<h3 id="question-7-1">question 7</h3>

<p>si on reprend tout depuis le début en monitorant <code class="highlighter-rouge">Loopback</code> avec Wireshark, c’est la fête:</p>

<ol>
  <li>création du premier process de a-tracer.
    <div class="language-sh highlighter-rouge"><pre class="highlight"><code>Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
cp        0      0 0.0.0.0:12345           0.0.0.0:<span class="k">*</span>               LISTEN      7303/a-tracer   
</code></pre>
    </div>
  </li>
  <li>première connexion sur le process de <code class="highlighter-rouge">a-tracer</code></li>
</ol>

<p><a href=""><a href="/00illustrations/wireshark1.png"><img src="/00illustrations/wireshark1.png" /></a></a></p>

<p>Le joli 3 way hand shake ! Les adresses IP sont les mêmes comme c’est un une communication entre un client TCP et un client au sein de la même machine.</p>

<p>nous avons tous les informations concernant les ports dans wireshark mais netstat nous donnes ces infos aussi:</p>

<div class="language-sh highlighter-rouge"><pre class="highlight"><code>tcp        0      0 127.0.0.1:12345         127.0.0.1:47541         ESTABLISHED 7308/a-tracer   
tcp        0      0 127.0.0.1:47541         127.0.0.1:12345         ESTABLISHED 7307/nc  
</code></pre>
</div>

<p>7303 reste en écoute</p>

<ol>
  <li>seconde connexion sur le process de <code class="highlighter-rouge">a-tracer</code></li>
</ol>

<div class="language-sh highlighter-rouge"><pre class="highlight"><code>tcp        0      0 127.0.0.1:12345         127.0.0.1:47545         ESTABLISHED 7343/a-tracer   
tcp        0      0 127.0.0.1:47545         127.0.0.1:12345         ESTABLISHED 7342/nc   
</code></pre>
</div>

<p>nouveau 3 hand shake, 7303 fidèle au poste toujours en écoute pendant que son fils fait sa fête au le port 47545</p>

<ol>
  <li>création d’un nouveau processus <code class="highlighter-rouge">netcat</code> que nous trackons avec <code class="highlighter-rouge">strace nc localhost 12345</code></li>
</ol>

<p>une foule d’informations dont la fin nous montre le début du cycle de vie coté client.
Les appels système interessants sont:</p>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="n">socket</span><span class="p">(</span><span class="n">PF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="n">IPPROTO_TCP</span><span class="p">)</span> <span class="o">=</span> <span class="mi">3</span>
</code></pre>
</div>

<p>et</p>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="n">connect</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="p">{</span><span class="n">sa_family</span><span class="o">=</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">sin_port</span><span class="o">=</span><span class="n">htons</span><span class="p">(</span><span class="mi">12345</span><span class="p">),</span> <span class="n">sin_addr</span><span class="o">=</span><span class="n">inet_addr</span><span class="p">(</span><span class="s">"127.0.0.1"</span><span class="p">)},</span> <span class="mi">16</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span>
</code></pre>
</div>

<h3 id="question-8-1">question 8</h3>

<div class="language-sh highlighter-rouge"><pre class="highlight"><code><span class="gp">sol@debian:~$ </span>strace -e socket,bind,recvfrom nc -l -p 12345 -u localhost
socket<span class="o">(</span>PF_LOCAL, SOCK_STREAM|SOCK_CLOEXEC|SOCK_NONBLOCK, 0<span class="o">)</span> <span class="o">=</span> 3
socket<span class="o">(</span>PF_LOCAL, SOCK_STREAM|SOCK_CLOEXEC|SOCK_NONBLOCK, 0<span class="o">)</span> <span class="o">=</span> 3
socket<span class="o">(</span>PF_LOCAL, SOCK_STREAM|SOCK_CLOEXEC|SOCK_NONBLOCK, 0<span class="o">)</span> <span class="o">=</span> 3
socket<span class="o">(</span>PF_LOCAL, SOCK_STREAM|SOCK_CLOEXEC|SOCK_NONBLOCK, 0<span class="o">)</span> <span class="o">=</span> 3
socket<span class="o">(</span>PF_INET, SOCK_DGRAM, IPPROTO_UDP<span class="o">)</span> <span class="o">=</span> 3
<span class="nb">bind</span><span class="o">(</span>3, <span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_INET, <span class="nv">sin_port</span><span class="o">=</span>htons<span class="o">(</span>12345<span class="o">)</span>, <span class="nv">sin_addr</span><span class="o">=</span>inet_addr<span class="o">(</span><span class="s2">"0.0.0.0"</span><span class="o">)}</span>, 16<span class="o">)</span> <span class="o">=</span> 0
recvfrom<span class="o">(</span>3, <span class="s2">"Wed May 24 19:48:45 CDT 2017</span><span class="se">\n</span><span class="s2">"</span>, 8192, MSG_PEEK, <span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_INET, <span class="nv">sin_port</span><span class="o">=</span>htons<span class="o">(</span>46262<span class="o">)</span>, <span class="nv">sin_addr</span><span class="o">=</span>inet_addr<span class="o">(</span><span class="s2">"127.0.0.1"</span><span class="o">)}</span>, <span class="o">[</span>16]<span class="o">)</span> <span class="o">=</span> 29
invalid connection to <span class="o">[</span>127.0.0.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>127.0.0.1] 46262
</code></pre>
</div>

<div class="language-sh highlighter-rouge"><pre class="highlight"><code> <span class="o">=</span> -1 ENOENT <span class="o">(</span>No such file or directory<span class="o">)</span>
socket<span class="o">(</span>PF_LOCAL, SOCK_STREAM|SOCK_CLOEXEC|SOCK_NONBLOCK, 0<span class="o">)</span> <span class="o">=</span> 3
connect<span class="o">(</span>3, <span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_LOCAL, <span class="nv">sun_path</span><span class="o">=</span><span class="s2">"/var/run/nscd/socket"</span><span class="o">}</span>, 110<span class="o">)</span> <span class="o">=</span> -1 ENOENT <span class="o">(</span>No such file or directory<span class="o">)</span>
socket<span class="o">(</span>PF_LOCAL, SOCK_STREAM|SOCK_CLOEXEC|SOCK_NONBLOCK, 0<span class="o">)</span> <span class="o">=</span> 3
connect<span class="o">(</span>3, <span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_LOCAL, <span class="nv">sun_path</span><span class="o">=</span><span class="s2">"/var/run/nscd/socket"</span><span class="o">}</span>, 110<span class="o">)</span> <span class="o">=</span> -1 ENOENT <span class="o">(</span>No such file or directory<span class="o">)</span>
socket<span class="o">(</span>PF_INET, SOCK_DGRAM, IPPROTO_UDP<span class="o">)</span> <span class="o">=</span> 3
connect<span class="o">(</span>3, <span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_INET, <span class="nv">sin_port</span><span class="o">=</span>htons<span class="o">(</span>12345<span class="o">)</span>, <span class="nv">sin_addr</span><span class="o">=</span>inet_addr<span class="o">(</span><span class="s2">"127.0.0.1"</span><span class="o">)}</span>, 16<span class="o">)</span> <span class="o">=</span> 0
write<span class="o">(</span>3, <span class="s2">"Wed May 24 19:48:45 CDT 2017</span><span class="se">\n</span><span class="s2">"</span>, 29<span class="o">)</span> <span class="o">=</span> 29
</code></pre>
</div>

<p><a href=""><a href="/00illustrations/wireshark2.png"><img src="/00illustrations/wireshark2.png" /></a></a></p>

<h3 id="question-9-1">question 9</h3>

<div class="language-sh highlighter-rouge"><pre class="highlight"><code>sol       7303  0.0  0.0   4080   660 pts/1    S+   18:56   0:00 ./a-tracer
sol       7308  0.0  0.0      0     0 pts/1    Z+   18:56   0:00 <span class="o">[</span>a-tracer] &lt;defunct&gt;
sol       7342  0.0  0.0   6328  1660 pts/3    S+   19:15   0:00 nc localhost 12345
sol       7343  0.0  0.0   4220    80 pts/1    S+   19:15   0:00 ./a-tracer
sol       7390  0.0  0.0      0     0 pts/1    Z+   19:36   0:00 <span class="o">[</span>a-tracer] &lt;defunct&gt;
</code></pre>
</div>

<p>Concernant les processus fils terminés qui se transforment en “processus” zombie:</p>

<p>Un soucis de reallocation mémoire après la destruction d’un objet?</p>

<h2 id="3-client-tcp-simple-linux-pas-pour-le-labo">3. Client TCP simple (Linux) *pas pour le labo</h2>
<p>ressources:<br />
<a href="http://cvs.alphanet.ch/cgi-bin/cvsweb/~checkout~/schaefer/public/cours/HE-ARC/DECOUVERTE-OS-et-RESEAUX/script/code/client-TCP/donnee/RELEASES/simple-client.tar.gz?rev=HEAD;content-type=application%2Fx-gzip">simple-client.c (base)</a><br />
<a href="http://fs.teleinf.labinfo.eiaj.ch/samba/scratch/RVO/compilation-c-socket.mp4">video explicative</a><br />
<a href="http://broux.developpez.com/articles/c/sockets/">tuto sockets</a><br />
<a href="/reseau/reseau-programmation-sockets.html">mon poste sur les sockets</a></p>

<h3 id="question-3-abcd">question 3 (a,b,c,d)</h3>
<p>Implémentation de la fonction <code class="highlighter-rouge">tcp_connect()</code></p>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;unistd.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;netdb.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/socket.h&gt;
</span>
<span class="k">static</span> <span class="kt">FILE</span> <span class="o">*</span><span class="n">tcp_connect</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">hostname</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">port</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">FILE</span> <span class="o">*</span><span class="n">f</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">f</span> <span class="o">=</span> <span class="n">tcp_connect</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span>
        <span class="p">{</span>
        <span class="p">}</span>
        <span class="cm">/* else: failure */</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"%s remote-host port</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"%s: bad args.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">FILE</span> <span class="o">*</span><span class="nf">tcp_connect</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">hostname</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">FILE</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="kt">int</span> <span class="n">s</span><span class="p">;</span> 
    <span class="k">struct</span> <span class="n">addrinfo</span> <span class="n">hints</span><span class="p">;</span> 
    <span class="k">struct</span> <span class="n">addrinfo</span> <span class="o">*</span><span class="n">result</span><span class="p">,</span> <span class="o">*</span><span class="n">rp</span><span class="p">;</span>

    <span class="n">hints</span><span class="p">.</span><span class="n">ai_family</span> <span class="o">=</span> <span class="n">AF_UNSPEC</span><span class="p">;</span> <span class="cm">/* IPv4 or v6 */</span> 
    <span class="n">hints</span><span class="p">.</span><span class="n">ai_socktype</span> <span class="o">=</span> <span class="n">SOCK_STREAM</span><span class="p">;</span> <span class="cm">/* TCP */</span> 
    <span class="n">hints</span><span class="p">.</span><span class="n">ai_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> 
    <span class="n">hints</span><span class="p">.</span><span class="n">ai_protocol</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* any protocol */</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">s</span> <span class="o">=</span> <span class="n">getaddrinfo</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hints</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">)))</span> 
    <span class="p">{</span> 
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"getaddrinfo(): failed: %s.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">gai_strerror</span><span class="p">(</span><span class="n">s</span><span class="p">));</span> 
    <span class="p">}</span> 
    <span class="k">else</span> 
    <span class="p">{</span> 
        <span class="k">for</span> <span class="p">(</span><span class="n">rp</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span> <span class="n">rp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">rp</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">ai_next</span><span class="p">)</span> 
        <span class="p">{</span>
            <span class="c1">// AFFICHER UNE ADR 
</span>            <span class="kt">char</span> <span class="n">ipname</span><span class="p">[</span><span class="n">INET_ADDRSTRLEN</span><span class="p">];</span> 
            <span class="kt">char</span> <span class="n">servicename</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span> <span class="cm">/* "65535\0" */</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">getnameinfo</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">ai_addr</span><span class="p">,</span> 
                             <span class="n">rp</span><span class="o">-&gt;</span><span class="n">ai_addrlen</span><span class="p">,</span> 
                             <span class="n">ipname</span><span class="p">,</span> 
                             <span class="k">sizeof</span><span class="p">(</span><span class="n">ipname</span><span class="p">),</span> 
                             <span class="n">servicename</span><span class="p">,</span> 
                             <span class="k">sizeof</span><span class="p">(</span><span class="n">servicename</span><span class="p">),</span> 
                             <span class="n">NI_NUMERICHOST</span><span class="o">|</span><span class="n">NI_NUMERICSERV</span><span class="p">))</span> 
            <span class="p">{</span> 
                <span class="n">printf</span><span class="p">(</span><span class="s">"Trying connection to host %s:%s ...</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> 
                        <span class="n">ipname</span><span class="p">,</span> 
                        <span class="n">servicename</span><span class="p">);</span> 
            
                <span class="cm">/* CREATION DE SOCKET */</span> 
                <span class="k">if</span> <span class="p">((</span><span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">ai_family</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">ai_socktype</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">ai_protocol</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> 
                <span class="p">{</span> 
                    <span class="n">perror</span><span class="p">(</span><span class="s">"socket() failed: "</span><span class="p">);</span> 
                <span class="p">}</span>
                <span class="cm">/* connexion */</span> 
                <span class="k">if</span> <span class="p">(</span><span class="n">connect</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">ai_addr</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">ai_addrlen</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> 
                <span class="p">{</span>
                    <span class="c1">// ...
</span>                <span class="p">}</span> 
                <span class="k">else</span> 
                <span class="p">{</span> 
                    <span class="n">perror</span><span class="p">(</span><span class="s">"connect(): "</span><span class="p">);</span> 
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">freeaddrinfo</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">f</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<p><br />
<br />
<br />
<br /></p>

<h3 id="questions-4567">questions 4,5,6,7</h3>

<p>Appels système: après <code class="highlighter-rouge">strace -e socket,connect ./simple-client localhost 7000</code></p>
<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="n">socket</span><span class="p">(</span><span class="n">PF_LOCAL</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="o">|</span><span class="n">SOCK_CLOEXEC</span><span class="o">|</span><span class="n">SOCK_NONBLOCK</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="mi">3</span>

<span class="n">connect</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="p">{</span><span class="n">sa_family</span><span class="o">=</span><span class="n">AF_LOCAL</span><span class="p">,</span> <span class="n">sun_path</span><span class="o">=</span><span class="s">"/var/run/nscd/socket"</span><span class="p">},</span> <span class="mi">110</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="n">ENOENT</span> <span class="p">(</span><span class="n">No</span> <span class="n">such</span> <span class="n">file</span> <span class="n">or</span> <span class="n">directory</span><span class="p">)</span>

<span class="n">socket</span><span class="p">(</span><span class="n">PF_LOCAL</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="o">|</span><span class="n">SOCK_CLOEXEC</span><span class="o">|</span><span class="n">SOCK_NONBLOCK</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="mi">3</span>

<span class="n">connect</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="p">{</span><span class="n">sa_family</span><span class="o">=</span><span class="n">AF_LOCAL</span><span class="p">,</span> <span class="n">sun_path</span><span class="o">=</span><span class="s">"/var/run/nscd/socket"</span><span class="p">},</span> <span class="mi">110</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="n">ENOENT</span> <span class="p">(</span><span class="n">No</span> <span class="n">such</span> <span class="n">file</span> <span class="n">or</span> <span class="n">directory</span><span class="p">)</span>

<span class="n">socket</span><span class="p">(</span><span class="n">PF_NETLINK</span><span class="p">,</span> <span class="n">SOCK_RAW</span><span class="p">,</span> <span class="n">NETLINK_ROUTE</span><span class="p">)</span> <span class="o">=</span> <span class="mi">3</span>

<span class="n">socket</span><span class="p">(</span><span class="n">PF_INET</span><span class="p">,</span> <span class="n">SOCK_DGRAM</span><span class="p">,</span> <span class="n">IPPROTO_IP</span><span class="p">)</span> <span class="o">=</span> <span class="mi">3</span>

<span class="n">connect</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="p">{</span><span class="n">sa_family</span><span class="o">=</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">sin_port</span><span class="o">=</span><span class="n">htons</span><span class="p">(</span><span class="mi">7000</span><span class="p">),</span> <span class="n">sin_addr</span><span class="o">=</span><span class="n">inet_addr</span><span class="p">(</span><span class="s">"127.0.0.1"</span><span class="p">)},</span> <span class="mi">16</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">socket</span><span class="p">(</span><span class="n">PF_INET6</span><span class="p">,</span> <span class="n">SOCK_DGRAM</span><span class="p">,</span> <span class="n">IPPROTO_IP</span><span class="p">)</span> <span class="o">=</span> <span class="mi">3</span>

<span class="n">connect</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="p">{</span> <span class="n">sa_family</span><span class="o">=</span><span class="n">AF_INET6</span><span class="p">,</span>
             <span class="n">sin6_port</span><span class="o">=</span><span class="n">htons</span><span class="p">(</span><span class="mi">7000</span><span class="p">),</span>
             <span class="n">inet_pton</span><span class="p">(</span><span class="n">AF_INET6</span><span class="p">,</span> <span class="s">"::1"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sin6_addr</span><span class="p">),</span>
             <span class="n">sin6_flowinfo</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
             <span class="n">sin6_scope_id</span><span class="o">=</span><span class="mi">0</span> 
          <span class="p">},</span> 
          <span class="mi">28</span>
        <span class="p">)</span> 
<span class="o">=</span> <span class="mi">0</span>

<span class="n">Trying</span> <span class="n">connection</span> <span class="n">to</span> <span class="n">host</span> <span class="o">::</span><span class="mi">1</span><span class="o">:</span><span class="mi">7000</span> <span class="p">...</span>

<span class="n">socket</span><span class="p">(</span><span class="n">PF_INET6</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="n">IPPROTO_TCP</span><span class="p">)</span> <span class="o">=</span> <span class="mi">3</span>

<span class="n">connect</span><span class="p">(</span>
        <span class="mi">3</span><span class="p">,</span> <span class="p">{</span> <span class="n">sa_family</span><span class="o">=</span><span class="n">AF_INET6</span><span class="p">,</span> 
             <span class="n">sin6_port</span><span class="o">=</span><span class="n">htons</span><span class="p">(</span><span class="mi">7000</span><span class="p">),</span> 
             <span class="n">inet_pton</span><span class="p">(</span><span class="n">AF_INET6</span><span class="p">,</span> <span class="s">"::1"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sin6_addr</span><span class="p">),</span>
             <span class="n">sin6_flowinfo</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sin6_scope_id</span><span class="o">=</span><span class="mi">0</span>
            <span class="p">},</span> <span class="mi">28</span>
        <span class="p">)</span> 
<span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="n">ECONNREFUSED</span> <span class="p">(</span><span class="n">Connection</span> <span class="n">refused</span><span class="p">)</span>


<span class="n">connect</span><span class="p">()</span><span class="o">:</span> <span class="o">:</span> <span class="n">Connection</span> <span class="n">refused</span>
<span class="n">Trying</span> <span class="n">connection</span> <span class="n">to</span> <span class="n">host</span> <span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="o">:</span><span class="mi">7000</span> <span class="p">...</span>
<span class="n">socket</span><span class="p">(</span><span class="n">PF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="n">IPPROTO_TCP</span><span class="p">)</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">connect</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="p">{</span><span class="n">sa_family</span><span class="o">=</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">sin_port</span><span class="o">=</span><span class="n">htons</span><span class="p">(</span><span class="mi">7000</span><span class="p">),</span> <span class="n">sin_addr</span><span class="o">=</span><span class="n">inet_addr</span><span class="p">(</span><span class="s">"127.0.0.1"</span><span class="p">)},</span> <span class="mi">16</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span>
<span class="o">+++</span> <span class="n">exited</span> <span class="n">with</span> <span class="mi">1</span> <span class="o">+++</span>
</code></pre>
</div>

<p><br /><br /><br /></p>

<p><a href=""><a href="/00illustrations/res_labo5/wireshark3.png"><img src="/00illustrations/res_labo5/wireshark3.png" /></a></a></p>

<p><br /></p>

<p>fonctions de la <strong>libc</strong> utilisées après 
<code class="highlighter-rouge">ltrace ./simple-client localhost 7000</code></p>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="n">__libc_start_main</span><span class="p">(</span><span class="mh">0x4007a6</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mh">0x7ffe79c13c18</span><span class="p">,</span> <span class="mh">0x4009b0</span> <span class="o">&lt;</span><span class="n">unfinished</span> <span class="p">...</span><span class="o">&gt;</span>

<span class="n">getaddrinfo</span><span class="p">(</span><span class="s">"localhost"</span><span class="p">,</span> <span class="s">"7000"</span><span class="p">,</span> <span class="mh">0x7ffe79c13ab0</span><span class="p">,</span> <span class="mh">0x7ffe79c13aa8</span><span class="p">)</span>            <span class="o">=</span> <span class="mi">0</span>
<span class="n">getnameinfo</span><span class="p">(</span><span class="mh">0x16271e0</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="s">"Xg</span><span class="se">\356</span><span class="s">w</span><span class="se">\355\177</span><span class="s">"</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>                 <span class="o">=</span> <span class="mi">0</span>

<span class="n">printf</span><span class="p">(</span><span class="s">"Trying connection to host %s:%s "</span><span class="p">...,</span> <span class="s">"::1"</span><span class="p">,</span> 
       <span class="s">"7000"</span><span class="n">Trying</span> <span class="n">connection</span> <span class="n">to</span> <span class="n">host</span> <span class="o">::</span><span class="mi">1</span><span class="o">:</span><span class="mi">7000</span> <span class="p">...</span> <span class="p">)</span>                       <span class="o">=</span> <span class="mi">39</span> 
<span class="n">socket</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>                                                            <span class="o">=</span> <span class="mi">3</span>
<span class="n">connect</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mh">0x16271e0</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mh">0x16271e0</span><span class="p">)</span>                                        <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">perror</span><span class="p">(</span><span class="s">"connect(): "</span><span class="n">connect</span><span class="p">()</span><span class="o">:</span> <span class="o">:</span> <span class="n">Connection</span> <span class="n">refused</span><span class="p">)</span>
                                                                            <span class="o">=</span> <span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span>
<span class="n">getnameinfo</span><span class="p">(</span><span class="mh">0x1627190</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="s">"::1"</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="s">"7000"</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>                         <span class="o">=</span> <span class="mi">0</span>
<span class="n">printf</span><span class="p">(</span><span class="s">"Trying connection to host %s:%s "</span><span class="p">...,</span> <span class="s">"127.0.0.1"</span><span class="p">,</span> 
       <span class="s">"7000"</span><span class="n">Trying</span> <span class="n">connection</span> <span class="n">to</span> <span class="n">host</span> <span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="o">:</span><span class="mi">7000</span> <span class="p">...)</span>
                                                                            <span class="o">=</span> <span class="mi">45</span>
<span class="n">socket</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>                                                             <span class="o">=</span> <span class="mi">4</span>
<span class="n">connect</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mh">0x1627190</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mh">0x1627190</span><span class="p">)</span>                                        <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">perror</span><span class="p">(</span><span class="s">"connect(): "</span><span class="n">connect</span><span class="p">()</span><span class="o">:</span> <span class="o">:</span> <span class="n">Connection</span> <span class="n">refused</span><span class="p">)</span>
                                                                            <span class="o">=</span> <span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span>
<span class="n">freeaddrinfo</span><span class="p">(</span><span class="mh">0x16271b0</span><span class="p">)</span>                                                     <span class="o">=</span> <span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span>
<span class="o">+++</span> <span class="n">exited</span> <span class="p">(</span><span class="n">status</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+++</span>
</code></pre>
</div>

<h3 id="question-8-2">question 8</h3>

<p>Ajout d’un printf() dans notre code affin d’avoir un affichage brut de la valeur du champ sin_port:</p>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="c1">// ...
// printf("Trying connection to host %s:%s ...\n", 
//         ipname, 
//         servicename); 
</span>
    <span class="c1">// affichage brut de la valeur du champ sin_port
</span>   <span class="k">if</span> <span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">ai_family</span> <span class="o">==</span> <span class="n">AF_INET</span><span class="p">)</span>
   <span class="p">{</span>
       <span class="n">printf</span><span class="p">(</span><span class="s">"HACK: raw port number: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
               <span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span> <span class="p">)</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">ai_addr</span><span class="p">)</span>   <span class="o">-&gt;</span><span class="n">sin_port</span><span class="p">);</span>
   <span class="p">}</span>                 <span class="c1">// cast
</span>
<span class="c1">// CREATION DE SOCKET 
// ...
</span></code></pre>
</div>

<p>Qui donne le résultat suivant:</p>
<div class="language-sh highlighter-rouge"><pre class="highlight"><code><span class="gp">sol@debian:~/LABOS/labo5/04CliendTCP/01simple-client$ </span>./simple-client localhost 7000
Trying connection to host ::1:7000 ...
connect<span class="o">()</span>: : Connection refused
Trying connection to host 127.0.0.1:7000 ...
HACK: raw port number: 22555
</code></pre>
</div>

<p>Nous avons effectivement une situation étrange. L’affichage de brut de notre port est différent de celui que nous avons introduit pourtant il se connecte bien sur le port 7000 et non le 22555.</p>

<p>On dirait donc que c’est un problème d’affichage du dans le bout de code que nous venons d’introduire.</p>

<blockquote>
  <p>La lecture du <strong>man</strong> de <strong>getaddrinfo</strong> était particulièrement interessante. Non seulement je crois avoir compris que c’est un problème d’<strong>endianess</strong> mais on y trouve un exemple d’un serveur et d’un client UDP.</p>
</blockquote>

<p><a href="http://manpagesfr.free.fr/man/man3/getaddrinfo.3.html">man getaddrinfo</a></p>

<h4 id="endianess"><strong>endianess</strong>:</h4>
<blockquote>
  <p>L’ordre dans lequel les octets sont organisés dans une case mémoire <strong>ou dans une communication</strong>. Big endian et Little endian sont deux architectures différentes.</p>
</blockquote>

<h5 id="big-endian">Big endian</h5>
<p><strong>byte de poids fort</strong> à gauche.<br />
Rangement en mémoire de la valeur <code class="highlighter-rouge">0xA0B70708</code> dans une structure mémoire de cases de 1 byte</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">adr:</th>
      <th style="text-align: center">0</th>
      <th style="text-align: center">1</th>
      <th style="text-align: center">2</th>
      <th style="text-align: center">3</th>
      <th style="text-align: center"> </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><strong>val:</strong></td>
      <td style="text-align: center">A0</td>
      <td style="text-align: center">B7</td>
      <td style="text-align: center">07</td>
      <td style="text-align: center">08</td>
      <td style="text-align: center">…</td>
    </tr>
  </tbody>
</table>

<p>Rangement en mémoire de la valeur <code class="highlighter-rouge">0xA0B70708</code> dans une structure mémoire de cases de 2 byte:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">0</th>
      <th style="text-align: center">1</th>
      <th style="text-align: center"> </th>
      <th style="text-align: center">2</th>
      <th style="text-align: center">3</th>
      <th style="text-align: center"> </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">A0</td>
      <td style="text-align: center">B7</td>
      <td style="text-align: center"> </td>
      <td style="text-align: center">07</td>
      <td style="text-align: center">08</td>
      <td style="text-align: center">…</td>
    </tr>
  </tbody>
</table>

<p><span style="color:#F92672"><strong>Tous les protocoles TCP/IP communiquent en big-endian</strong></span></p>

<h5 id="little-endian">Little endian</h5>
<p><strong>byte de poid faible</strong> à gauche. <br />
Rangement en mémoire de la valeur <code class="highlighter-rouge">0xA0B70708</code> dans une structure mémoire de cases de 1 byte</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">adr:</th>
      <th style="text-align: center">0</th>
      <th style="text-align: center">1</th>
      <th style="text-align: center">2</th>
      <th style="text-align: center">3</th>
      <th style="text-align: center"> </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><strong>val:</strong></td>
      <td style="text-align: center">08</td>
      <td style="text-align: center">07</td>
      <td style="text-align: center">B7</td>
      <td style="text-align: center">A0</td>
      <td style="text-align: center">…</td>
    </tr>
  </tbody>
</table>

<p>Rangement en mémoire de la valeur <code class="highlighter-rouge">0xA0B70708</code> dans une structure mémoire de cases de 2 byte:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">0</th>
      <th style="text-align: center">1</th>
      <th style="text-align: center"> </th>
      <th style="text-align: center">2</th>
      <th style="text-align: center">3</th>
      <th style="text-align: center"> </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">07</td>
      <td style="text-align: center">08</td>
      <td style="text-align: center"> </td>
      <td style="text-align: center">A0</td>
      <td style="text-align: center">B7</td>
      <td style="text-align: center">…</td>
    </tr>
  </tbody>
</table>

<p><span style="color:#F92672"><strong>X86</strong></span> ainsi que la majorité des pc actuels <span style="color:#F92672"><strong>fonctionne en Little endian</strong> </span></p>

<h5 id="reponse">reponse</h5>

<ul>
  <li>7000  = 0x 1B 58</li>
  <li>22555 = 0x 58 1B</li>
</ul>

<p>Bingo ! C’est donc bien un problème d’endianess.</p>

<h3 id="question-9-2">question 9</h3>

<h4 id="a-b-c">a, b, c:</h4>

<ul>
  <li>
    <p>conversion d’un socket en fichier text dans la fonction tcp_connect()</p>
  </li>
  <li>
    <p>ajout d’un buffer et d’un <strong>fgets()</strong> dans le main qui va capturer la première ligne de ce que le serveur a à nous dire et <strong>puts()</strong> l’ajouter dans <code class="highlighter-rouge">buff</code>.</p>
  </li>
</ul>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;unistd.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;netdb.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/socket.h&gt;
</span>
<span class="k">static</span> <span class="kt">FILE</span> <span class="o">*</span><span class="n">tcp_connect</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">hostname</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">port</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">FILE</span> <span class="o">*</span><span class="n">f</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">f</span> <span class="o">=</span> <span class="n">tcp_connect</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span>
        <span class="p">{</span>
            <span class="c1">// creation d'un buffer affin de stocker la premiere ligne
</span>            <span class="kt">char</span> <span class="n">buff</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">fgets</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buff</span><span class="p">),</span> <span class="n">f</span><span class="p">))</span>
            <span class="p">{</span> 
                <span class="n">puts</span><span class="p">(</span><span class="n">buff</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="c1">// else: fail
</span>    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"%s remote-host port</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"%s: bad args.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">FILE</span> <span class="o">*</span><span class="nf">tcp_connect</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">hostname</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">FILE</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="kt">int</span> <span class="n">s</span><span class="p">;</span> 
    <span class="k">struct</span> <span class="n">addrinfo</span> <span class="n">hints</span><span class="p">;</span> 
    <span class="k">struct</span> <span class="n">addrinfo</span> <span class="o">*</span><span class="n">result</span><span class="p">,</span> <span class="o">*</span><span class="n">rp</span><span class="p">;</span>

    <span class="n">hints</span><span class="p">.</span><span class="n">ai_family</span> <span class="o">=</span> <span class="n">AF_UNSPEC</span><span class="p">;</span> <span class="c1">// IPv4 or v6  
</span>    <span class="n">hints</span><span class="p">.</span><span class="n">ai_socktype</span> <span class="o">=</span> <span class="n">SOCK_STREAM</span><span class="p">;</span> <span class="c1">// TCP  
</span>    <span class="n">hints</span><span class="p">.</span><span class="n">ai_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> 
    <span class="n">hints</span><span class="p">.</span><span class="n">ai_protocol</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// any protocol 
</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">s</span> <span class="o">=</span> <span class="n">getaddrinfo</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hints</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">)))</span> 
    <span class="p">{</span> 
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"getaddrinfo(): failed: %s.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">gai_strerror</span><span class="p">(</span><span class="n">s</span><span class="p">));</span> 
    <span class="p">}</span> 
    <span class="k">else</span> 
    <span class="p">{</span> 
        <span class="k">for</span> <span class="p">(</span><span class="n">rp</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span> <span class="n">rp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">rp</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">ai_next</span><span class="p">)</span> 
        <span class="p">{</span>
            <span class="c1">// AFFICHER UNE ADR 
</span>            <span class="kt">char</span> <span class="n">ipname</span><span class="p">[</span><span class="n">INET_ADDRSTRLEN</span><span class="p">];</span> 
            <span class="kt">char</span> <span class="n">servicename</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span> <span class="c1">// "65535\0" 
</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">getnameinfo</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">ai_addr</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">ai_addrlen</span><span class="p">,</span> 
                             <span class="n">ipname</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ipname</span><span class="p">),</span> 
                             <span class="n">servicename</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">servicename</span><span class="p">),</span> 
                             <span class="n">NI_NUMERICHOST</span><span class="o">|</span><span class="n">NI_NUMERICSERV</span><span class="p">))</span> 
            <span class="p">{</span> 
                <span class="n">printf</span><span class="p">(</span><span class="s">"Trying connection to host %s:%s ...</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> 
                        <span class="n">ipname</span><span class="p">,</span> 
                        <span class="n">servicename</span><span class="p">);</span> 

                <span class="c1">//     // affichage brut de la valeur du champ sin_port
</span>                <span class="c1">// if (rp-&gt;ai_family == AF_INET)
</span>                <span class="c1">// {
</span>                <span class="c1">//     printf("HACK: raw port number: %d\n",
</span>                <span class="c1">//           ((struct sockaddr_in * ) rp-&gt;ai_addr)-&gt;sin_port);
</span>                <span class="c1">// }                 // cast
</span>            
                <span class="c1">// CREATION DE SOCKET  
</span>                <span class="k">if</span> <span class="p">((</span><span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">ai_family</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">ai_socktype</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">ai_protocol</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> 
                <span class="p">{</span> 
                    <span class="n">perror</span><span class="p">(</span><span class="s">"socket() failed: "</span><span class="p">);</span> 
                <span class="p">}</span>

                <span class="c1">// CONNEXION 
</span>                <span class="k">else</span>
                <span class="p">{</span> 
                    <span class="k">if</span> <span class="p">(</span><span class="n">connect</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">ai_addr</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">ai_addrlen</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> 
                    <span class="p">{</span>
                        <span class="c1">// conversion de socket en un FILE *
</span>                        <span class="c1">// fdopen() permet d'utiliser un socket comme un fichier
</span>                        <span class="k">if</span> <span class="p">((</span><span class="n">f</span> <span class="o">=</span> <span class="n">fdopen</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">"r+"</span><span class="p">)))</span> 
                        <span class="p">{</span> <span class="c1">// utilisation de fonctions classiques maintenant possible
</span>                            <span class="k">break</span><span class="p">;</span> <span class="c1">// !! Si on return maintenant, la memoire n'est pas liberee!
</span>                        <span class="p">}</span>
                    <span class="p">}</span> 
                    <span class="k">else</span> 
                    <span class="p">{</span> 
                        <span class="n">perror</span><span class="p">(</span><span class="s">"connect(): "</span><span class="p">);</span> 
                    <span class="p">}</span>
                    <span class="n">close</span><span class="p">(</span><span class="n">s</span><span class="p">);</span> <span class="c1">// new -&gt; delete | open -&gt; close
</span>                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">freeaddrinfo</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">f</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<p><br /><br /><br />
<a href=""><a href="/00illustrations/res_labo5/wireshark5.png"><img src="/00illustrations/res_labo5/wireshark5.png" /></a></a>
<br /><br /><br /></p>

<h2 id="4-client-http">4. Client HTTP</h2>

<p>Pour pas abuser sur la longueur de la page, Le détail de comment en arriver à ce code se trouve sur une autre <a href="\reseau\reseau-programmation-sockets.html">page</a></p>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="cp">#include&lt;stdio.h&gt;
#include&lt;string.h&gt;
#include&lt;sys/socket.h&gt;
#include&lt;netdb.h&gt; // hostent
#include&lt;arpa/inet.h&gt; // inet_addr
#include&lt;unistd.h&gt;
</span>
<span class="n">bool</span> <span class="n">resolveDomain</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">ip</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// test arguments
</span>    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"</span><span class="se">\n</span><span class="s">%s bad args</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// variables
</span>    <span class="kt">int</span>   <span class="n">_socket</span><span class="p">;</span>
    <span class="kt">char</span><span class="o">*</span> <span class="n">_message</span><span class="p">;</span>
    <span class="kt">char</span>  <span class="n">_buffer</span><span class="p">[</span><span class="mi">4096</span><span class="p">];</span>

    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">_server</span><span class="p">;</span>

    <span class="c1">// s'assure qu'argv[1] est une IP notation point.
</span>    <span class="n">resolveDomain</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

    <span class="c1">// creation du socket
</span>    <span class="n">_socket</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">// ipv4, TCP, 0 (=IPPROTO_IP)
</span>    <span class="k">if</span> <span class="p">(</span><span class="n">_socket</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"Could not create socket"</span><span class="p">);</span>
    <span class="p">}</span>   

    <span class="c1">// initialisation des membres de l'objet _server
</span>    <span class="n">_server</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">inet_addr</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span> <span class="c1">// ip
</span>    <span class="n">_server</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>                 <span class="c1">// ipv4
</span>    <span class="n">_server</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">80</span><span class="p">);</span>                 <span class="c1">// port (client HTTP = port 80)
</span>    
    <span class="c1">// connexion au serveur
</span>    <span class="k">if</span> <span class="p">(</span><span class="n">connect</span><span class="p">(</span><span class="n">_socket</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">_server</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">_server</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"connection error</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">puts</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">connected</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

    <span class="c1">// envoie requete HTTP
</span>    <span class="n">_message</span> <span class="o">=</span> <span class="s">"GET / HTTP/1.1</span><span class="se">\r\n\r\n</span><span class="s">"</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">send</span><span class="p">(</span><span class="n">_socket</span><span class="p">,</span> <span class="n">_message</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">_message</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"Send failed</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// reponse du serveur
</span>    <span class="k">if</span> <span class="p">(</span><span class="n">recv</span><span class="p">(</span><span class="n">_socket</span><span class="p">,</span> <span class="n">_buffer</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"recv failed"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">puts</span><span class="p">(</span><span class="s">"Reply received</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">puts</span><span class="p">(</span><span class="n">_buffer</span><span class="p">);</span>

    <span class="n">close</span><span class="p">(</span><span class="n">_socket</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">resolveDomain</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">ip</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">_hostname</span> <span class="o">=</span> <span class="n">ip</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">hostent</span> <span class="o">*</span><span class="n">_he</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">in_addr</span> <span class="o">**</span><span class="n">_addr_list</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">_he</span> <span class="o">=</span> <span class="n">gethostbyname</span><span class="p">(</span><span class="n">_hostname</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"gethostbyname error"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">_addr_list</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">in_addr</span> <span class="o">**</span> <span class="p">)</span><span class="n">_he</span><span class="o">-&gt;</span><span class="n">h_addr_list</span><span class="p">;</span>

    <span class="n">strcpy</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">inet_ntoa</span><span class="p">(</span><span class="o">*</span><span class="n">_addr_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<div class="language-sh highlighter-rouge"><pre class="highlight"><code><span class="gp">sol@debian:~/code/sockets/clientHTTP-Lab5$ </span>./clientHTTPv1 gandalf.teleinf.labinfo.eiaj.ch 80

connected

Reply received

HTTP/1.1 400 Bad Request
Date: Tue, 30 May 2017 12:33:58 GMT
Server: Apache/2.2.22 <span class="o">(</span>Debian<span class="o">)</span>
Vary: Accept-Encoding
Content-Length: 301
Connection: close
Content-Type: text/html; <span class="nv">charset</span><span class="o">=</span>iso-8859-1

&lt;!DOCTYPE HTML PUBLIC <span class="s2">"-//IETF//DTD HTML 2.0//EN"</span>&gt;
&lt;html&gt;&lt;head&gt;
&lt;title&gt;400 Bad Request&lt;/title&gt;
&lt;/head&gt;&lt;body&gt;
&lt;h1&gt;Bad Request&lt;/h1&gt;
&lt;p&gt;Your browser sent a request that this server could not understand.&lt;br /&gt;
&lt;/p&gt;
&lt;hr&gt;
&lt;address&gt;Apache/2.2.22 <span class="o">(</span>Debian<span class="o">)</span> Server at _default_ Port 80&lt;/address&gt;
&lt;/body&gt;&lt;/html&gt;

<span class="gp">sol@debian:~/code/sockets/clientHTTP-Lab5$ </span>./clientHTTPv1 www.google.com 80

connected

Reply received

HTTP/1.1 302 Found
Cache-Control: private
Content-Type: text/html; <span class="nv">charset</span><span class="o">=</span>UTF-8
Referrer-Policy: no-referrer
Location: http://www.google.ch/?gfe_rd<span class="o">=</span>cr&amp;ei<span class="o">=</span>1GYtWbrcHqTC8gfh2q6ABA
Content-Length: 258
Date: Tue, 30 May 2017 12:34:28 GMT

&lt;HTML&gt;&lt;HEAD&gt;&lt;meta http-equiv<span class="o">=</span><span class="s2">"content-type"</span> <span class="nv">content</span><span class="o">=</span><span class="s2">"text/html;charset=utf-8"</span>&gt;
&lt;TITLE&gt;302 Moved&lt;/TITLE&gt;&lt;/HEAD&gt;&lt;BODY&gt;
&lt;H1&gt;302 Moved&lt;/H1&gt;
The document has moved
&lt;A <span class="nv">HREF</span><span class="o">=</span><span class="s2">"http://www.google.ch/?gfe_rd=cr&amp;amp;ei=1GYtWbrcHqTC8gfh2q6ABA"</span>&gt;here&lt;/A&gt;.
&lt;/BODY&gt;&lt;/HTML&gt;

</code></pre>
</div>
<p><br /><br /><br />
<a href=""><a href="/00illustrations/res_labo5/wireshark6.png"><img src="/00illustrations/res_labo5/wireshark6.png" /></a></a>
<br /><br /><br />
<a href=""><a href="/00illustrations/res_labo5/wireshark7.png"><img src="/00illustrations/res_labo5/wireshark7.png" /></a></a>
<br /><br /><br /></p>

<h2 id="5-serveur-tcp-multiprocessus">5. serveur TCP multiprocessus</h2>

<p>Pour pas abuser sur la longueur de la page, Le détail de comment en arriver à ce code se trouvent sur une autre <a href="\reseau\reseau-programmation-sockets.html">page</a></p>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="cp">#include&lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include&lt;string.h&gt;
#include&lt;sys/socket.h&gt;
#include&lt;netdb.h&gt;    
#include&lt;arpa/inet.h&gt;
#include&lt;unistd.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
   <span class="c1">// variables
</span>    <span class="kt">int</span>    <span class="n">_socket</span><span class="p">,</span> <span class="n">_newSock</span><span class="p">,</span> <span class="n">c</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">_server</span><span class="p">,</span> <span class="n">_client</span><span class="p">;</span>
    <span class="kt">char</span><span class="o">*</span>  <span class="n">_message</span><span class="p">;</span>

    <span class="c1">// creation de socket
</span>    <span class="n">_socket</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_socket</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Could not create socket</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// initialisation des membres de l'objet _server
</span>    <span class="n">_server</span><span class="p">.</span><span class="n">sin_family</span>      <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
    <span class="n">_server</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">INADDR_ANY</span><span class="p">;</span>
    <span class="n">_server</span><span class="p">.</span><span class="n">sin_port</span>        <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span> <span class="c1">// conversion (char-&gt;int)-&gt;NetworkShort
</span>
    <span class="c1">// bind
</span>    <span class="k">if</span> <span class="p">(</span><span class="n">bind</span><span class="p">(</span><span class="n">_socket</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span> <span class="p">)</span><span class="o">&amp;</span><span class="n">_server</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">_server</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">bind failded</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">bind done</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

    <span class="c1">// ecoute
</span>    <span class="n">listen</span><span class="p">(</span><span class="n">_socket</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

    <span class="c1">// Accepte les connexions
</span>    <span class="n">puts</span><span class="p">(</span><span class="s">"Waiting for incoming connections...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">c</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span><span class="p">);</span>

    <span class="k">while</span> <span class="p">(</span> <span class="p">(</span><span class="n">_newSock</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">_socket</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span> <span class="p">)</span><span class="o">&amp;</span><span class="n">_client</span><span class="p">,</span> <span class="p">(</span><span class="n">socklen_t</span> <span class="o">*</span> <span class="p">)</span><span class="o">&amp;</span><span class="n">c</span><span class="p">))</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// affiche les infos du _client
</span>        <span class="n">printf</span><span class="p">(</span><span class="s">"Connection from %s:%d accepted</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">inet_ntoa</span><span class="p">(</span><span class="n">_client</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">),</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">_client</span><span class="p">.</span><span class="n">sin_port</span><span class="p">));</span>

        <span class="c1">// repond au client
</span>        <span class="n">_message</span> <span class="o">=</span> <span class="s">"Hey client! </span><span class="se">\n</span><span class="s">."</span><span class="p">;</span>
        <span class="n">write</span><span class="p">(</span><span class="n">_newSock</span><span class="p">,</span> <span class="n">_message</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">_message</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">_newSock</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"accept failed</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<p><br /><br /><br />
<a href=""><a href="/00illustrations/res_labo5/wireshark8.png"><img src="/00illustrations/res_labo5/wireshark8.png" /></a></a>
<br /><br /><br /></p>

<h2 id="6-serveur-tcp-multi-thread">6. serveur TCP multi-thread</h2>

<p>Pour pas abuser sur la longueur de la page, Le détail de comment en arriver à ce code se trouvent sur une autre <a href="\reseau\reseau-programmation-sockets.html">page</a></p>

<p>makefile:</p>
<div class="language-makefile highlighter-rouge"><pre class="highlight"><code><span class="nv">TARGET</span><span class="o">=</span>serveurTCPmulti-Threads
<span class="nv">CFLAGS</span><span class="o">=</span>-Wall -lpthread

<span class="nl">all</span><span class="o">:</span> <span class="nf">$(TARGET)</span>

<span class="nl">clean</span><span class="o">:</span>
	rm -f <span class="nv">$(TARGET)</span>
</code></pre>
</div>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="cp">#include&lt;stdio.h&gt;
#include&lt;stdlib.h&gt;
#include&lt;string.h&gt;    // strlen
#include&lt;sys/socket.h&gt;
#include&lt;arpa/inet.h&gt; // inet_addr
#include&lt;unistd.h&gt;    // write
#include&lt;pthread.h&gt;   // threading
</span>
<span class="kt">void</span><span class="o">*</span> <span class="n">connection_handler</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
   <span class="c1">// variables
</span>    <span class="kt">int</span>    <span class="n">_socket</span><span class="p">,</span> <span class="n">_newSock</span><span class="p">,</span> <span class="n">c</span><span class="p">;</span>
    <span class="kt">int</span> <span class="o">*</span>  <span class="n">_newSockPtr</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">_server</span><span class="p">,</span> <span class="n">_client</span><span class="p">;</span>
    <span class="kt">char</span><span class="o">*</span>  <span class="n">_message</span><span class="p">;</span>

    <span class="c1">// creation de socket
</span>    <span class="n">_socket</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_socket</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Could not create socket</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// initialisation des membres de l'objet _server
</span>    <span class="n">_server</span><span class="p">.</span><span class="n">sin_family</span>      <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
    <span class="n">_server</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">INADDR_ANY</span><span class="p">;</span>
    <span class="n">_server</span><span class="p">.</span><span class="n">sin_port</span>        <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span> <span class="c1">// conversion (char-&gt;int)-&gt;NetworkShort
</span>
    <span class="c1">// bind
</span>    <span class="k">if</span> <span class="p">(</span><span class="n">bind</span><span class="p">(</span><span class="n">_socket</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span> <span class="p">)</span><span class="o">&amp;</span><span class="n">_server</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">_server</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">bind failded</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">bind done</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

    <span class="c1">// ecoute
</span>    <span class="n">listen</span><span class="p">(</span><span class="n">_socket</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

    <span class="c1">// Accepte les connexions
</span>    <span class="n">puts</span><span class="p">(</span><span class="s">"Waiting for incoming connections...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">c</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span><span class="p">);</span>

    <span class="k">while</span> <span class="p">(</span> <span class="p">(</span><span class="n">_newSock</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">_socket</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span> <span class="p">)</span><span class="o">&amp;</span><span class="n">_client</span><span class="p">,</span> <span class="p">(</span><span class="n">socklen_t</span> <span class="o">*</span> <span class="p">)</span><span class="o">&amp;</span><span class="n">c</span><span class="p">))</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// affiche les infos du _client
</span>        <span class="n">printf</span><span class="p">(</span><span class="s">"Connection from %s:%d accepted</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">inet_ntoa</span><span class="p">(</span><span class="n">_client</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">),</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">_client</span><span class="p">.</span><span class="n">sin_port</span><span class="p">));</span>

        <span class="c1">// repond au client
</span>        <span class="n">_message</span> <span class="o">=</span> <span class="s">"Hey client! You will be assigned to a handler... </span><span class="se">\n</span><span class="s">."</span><span class="p">;</span>
        <span class="n">write</span><span class="p">(</span><span class="n">_newSock</span><span class="p">,</span> <span class="n">_message</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">_message</span><span class="p">));</span>

        <span class="c1">// creation d'un nouveau thread
</span>        <span class="n">pthread_t</span> <span class="n">sniffer_thread</span><span class="p">;</span>
        <span class="n">_newSockPtr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
        <span class="o">*</span><span class="n">_newSockPtr</span> <span class="o">=</span> <span class="n">_newSock</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">pthread_create</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">sniffer_thread</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">connection_handler</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span> <span class="p">)</span> <span class="n">_newSockPtr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">puts</span><span class="p">(</span><span class="s">"could not create thread</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
            <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">perror</span><span class="p">(</span><span class="s">"Handler assigned</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">_newSock</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"accept failed</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="o">*</span> <span class="nf">connection_handler</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">socket_desc</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// prend la description du socket
</span>    <span class="kt">int</span> <span class="n">sock</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">socket_desc</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">read_size</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">message</span><span class="p">,</span> <span class="n">client_message</span><span class="p">[</span><span class="mi">2000</span><span class="p">];</span>

    <span class="c1">// envoie quelques messages au client
</span>    <span class="n">message</span> <span class="o">=</span> <span class="s">"Greetings! I'm your connection handler</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
    <span class="n">write</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">message</span><span class="p">));</span>

    <span class="n">message</span> <span class="o">=</span> <span class="s">"Now type somthing and I will repeat it."</span><span class="p">;</span>
    <span class="n">write</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">message</span><span class="p">));</span>

    <span class="c1">// reception de message
</span>    <span class="k">while</span> <span class="p">((</span><span class="n">read_size</span> <span class="o">=</span> <span class="n">recv</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">client_message</span><span class="p">,</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// renvoie le message au client
</span>        <span class="n">write</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">client_message</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">client_message</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">read_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"Client disconnected"</span><span class="p">);</span>
        <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">read_size</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"recv failed"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// libere la memoire
</span>    <span class="n">free</span><span class="p">(</span><span class="n">socket_desc</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<p><br /><br /><br />
<a href=""><a href="/00illustrations/res_labo5/wireshark9.png"><img src="/00illustrations/res_labo5/wireshark9.png" /></a></a>
<br /><br /><br /></p>

<p><a href="https://support.sas.com/documentation/onlinedoc/sasc/doc750/html/lr2/select.htm">tuto utilistion select()</a></p>

</div>

<div>
	
	<div class="tbc"></div>
	
</div>

<!--<div class="share">
    <p>Share this post with: </p>
	<a href="https://twitter.com/intent/tweet?text=Reseau: Labo 5 Programmation Sockets@&amp;url=http://localhost:4000/reseau/reseau-labo5.html" class="twitter-share">
		<span class="fa-stack fa-lg">
			<i class="fa fa-circle fa-stack-2x"></i>
			<i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
		</span>
	</a>
    
	<a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/reseau/reseau-labo5.html" class="facebook-share">
		<span class="fa-stack fa-lg">
			<i class="fa fa-circle fa-stack-2x"></i>
			<i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
		</span>
	</a>
    
	<a href="https://plus.google.com/share?url=http://localhost:4000/reseau/reseau-labo5.html" class="googleplus-share">
		<span class="fa-stack fa-lg">
			<i class="fa fa-circle fa-stack-2x"></i>
			<i class="fa fa-google-plus fa-stack-1x fa-inverse"></i>
		</span>
	</a>
</div>
-->

<div id="disqus_thread"></div>


 
</div>


</article>

        </div>

    </body>

<footer class="site-footer">
    <div class="wrapper">
        <center>
            <p>
                <a class="link" href="/%20/">Home</a> /
                <a class="link" href="/archive/">Archive</a> /
                <a class="link" href="/category/">Category</a> /
                <a class="link" href="/tags/">Tags</a> /
                <a class="link" href="/about/">About</a> /
                <a class="link" href="/contact/">Contact</a>
            </p>
            <span><script>document.write(new Date().getFullYear());</script></span>
            <span>&copy;</span>

            <a href="mailto:sol.rosca@gmail.com?subject=Hello&nbsp;RoscaS"> RoscaS</a>
            <br>
        </center>
    </div>
</footer>

<foot>
    <foot>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Derictory -->

  <script src="http://code.jquery.com/jquery-1.7.2.min.js"></script>
  <script src="http://yandex.st/highlightjs/6.2/highlight.min.js"></script>

<!-- Hit analytics -->

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<!-- Directory -->

<script src="/js/main.js"></script>

</foot>

</foot>

</html>
