<!DOCTYPE html>
<html>

    <head>
        <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- CSS -->

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://localhost:4000/reseau/reseau-Labo-6-SNMP.html">
  <link rel="alternate" type="application/rss+xml" title="RoscaS" href="http://localhost:4000/feed.xml">

<!-- JS -->
  <!-- <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script> -->
  <script src="/js/mermaid.min.js"></script>

</head>


        
          <script>
	  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
			  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    
  ga('create', 'UA-99742998-1', 'auto');
  ga('send', 'pageview');
    
	</script>


        

        
    </head>

    <body>
        <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Reseau: Labo 6 SNMP &amp; Docker</title>
  <meta name="description" content="todo">
</head>


        <div class="wrapper">
            <header class="post-header">
	
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>
<script
  type="text/javascript"
  charset="utf-8"
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"
>
</script>
<script
  type="text/javascript"
  charset="utf-8"
  src="https://vincenttam.github.io/javascripts/MathJaxLocal.js"
>
</script>


    <center>
		<div class="post-title" itemprop="name headline">Reseau: Labo 6 SNMP & Docker</div>

		<div class="post-meta"><i class="fa fa-calendar-o"></i> <time datetime="03 Jul 2017" itemprop="datePublished">Jul 3 2017</time>

			&nbsp;&nbsp;•&nbsp;&nbsp;<i class="fa fa-user-secret"></i> <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Sol</span>
        	
			<br>
			<i class="fa fa-eye"></i> <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-pulse"></i></span>clicks</span>
		</div>

        	
        <div class="post-tags">
        	
			<a class="post-tags-item" href="http://localhost:4000/tags/">reseau</a>
        	
			
		</div>
    </center>

<div class="wrapper">

    <center>      
		<p>
			<a class="link" href="/">Home</a> /
			<a class="link" href="/archive/">Archive</a> /
			<a class="link" href="/category/">Category</a> / 
			<a class="link" href="/tags/">Tags</a> / 
			<a class="link" href="/about/">About</a> /
			<a class="link" href="/contact/">Contact</a>
    	</p>
    </center>
</div>
    
</header>

<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
<div class="post-content">
    <center>
	
	<p></p>
	
    </center>
	<h2>Directory</h2>
</div>

<div id="category"></div>

<div class="post-content" itemprop="articleBody">
    <h2 id="todo">todo</h2>

<p><a href="https://www.junian.net/2014/07/simple-http-server-and-client-in-python.html">client http Python</a></p>

<h2 id="sources">Sources</h2>
<ul>
  <li><a href="https://makina-corpus.com/blog/metier/2016/initiation-a-snmp-avec-python-pysnmp">explication de snmp + tuto Python</a></li>
  <li><a href="http://www.oidview.com/mibs/0/HOST-RESOURCES-MIB.html">oidview</a></li>
  <li><a href="https://www.junian.net/2014/07/simple-http-server-and-client-in-python.html">client http Python</a></li>
  <li><a href="http://luca.ntop.org/Teaching/Appunti/asn1.html">Layman’s Guide to a Subset of ASN.1, BER, and DER</a></li>
  <li><a href="https://manpages.debian.org">man</a></li>
</ul>

<h1 id="premiers-pas-avec-snmp">Premiers pas avec SNMP</h1>

<h2 id="objectifs">Objectifs</h2>
<ul>
  <li>interroger un agent <code class="highlighter-rouge">SNMP</code> avec des outils <code class="highlighter-rouge">UNIX</code> (modèle PULL <strong>client-serveur</strong> classique)</li>
  <li>concepts de base de la <strong>MIB</strong></li>
  <li>modèle <code class="highlighter-rouge">PUSH</code>: les traps</li>
</ul>

<h2 id="1-installation">1. Installation</h2>

<h2 id="2-">2. ?</h2>

<h2 id="3-experimentation">3. Experimentation</h2>

<h3 id="snmpget">snmpget</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>sol@debian:~$ snmpget -v 1 -c public 157.26.77.13 system.sysName.0
SNMPv2-MIB::sysName.0 = STRING: gandalf
</code></pre>
</div>

<p><a href="/00illustrations/labo6/wireshark1.png"><img src="/00illustrations/labo6/wireshark1.png" /></a></p>

<p>Nous voyons ici que l’information system.sysname.0 est répertoriée par l’<strong>OID</strong> <code class="highlighter-rouge">1.3.6.1.2.1.1.5.0</code> qui est équivalente à <code class="highlighter-rouge">.ISO.organization.DoD.Internet.management.MIB-2.system.sysName.0</code> en suivant l’arbre sur l’illustration suivante:</p>

<p><img src="https://makina-corpus.com/blog/metier/2016/pysnmp/snmp_mib.png" alt="alt" /></p>

<h3 id="snmpwalk">snmpwalk</h3>

<p>Ici nous voyons le <strong>10 premières réponses</strong> à la commande <code class="highlighter-rouge">snmpWalk</code> avec en argument l’ip <code class="highlighter-rouge">157.26.77.13</code> en <strong>community</strong> <code class="highlighter-rouge">public</code></p>

<div class="highlighter-rouge"><pre class="highlight"><code>sol@debian:~$ snmpwalk -v 1 -c public 157.26.77.13
SNMPv2-MIB::sysDescr.0 = STRING: Linux gandalf 3.10-0.bpo.2-amd64 #1 SMP Debian 3.10.5-1~bpo70+1 (2013-08-11) x86_64
SNMPv2-MIB::sysObjectID.0 = OID: NET-SNMP-MIB::netSnmpAgentOIDs.10
DISMAN-EVENT-MIB::sysUpTimeInstance = Timeticks: (113849707) 13 days, 4:14:57.07
SNMPv2-MIB::sysContact.0 = STRING: Marc SCHAEFER &lt;schaefer@alphanet.ch&gt;
SNMPv2-MIB::sysName.0 = STRING: gandalf
SNMPv2-MIB::sysLocation.0 = STRING: Salle rack SI Campus Arc 2 NE
SNMPv2-MIB::sysServices.0 = INTEGER: 72
SNMPv2-MIB::sysORLastChange.0 = Timeticks: (1) 0:00:00.01
SNMPv2-MIB::sysORID.1 = OID: SNMP-FRAMEWORK-MIB::snmpFrameworkMIBCompliance
</code></pre>
</div>

<p><a href="/00illustrations/labo6/wireshark2.png"><img src="/00illustrations/labo6/wireshark2.png" /></a></p>

<p>Sur la capture Wireshark nous voyons que cette commande est une automatisation de la commande <code class="highlighter-rouge">getnext</code>. Cette commande parcours toute l’arborescence de la <strong>MIB</strong> accessible à l’adresse ip: <code class="highlighter-rouge">157.26.77.13</code> Nous voyons aussi les <strong>OIDs</strong> des services correspondant aux prints de la commnde sur la capture Wireshark.</p>

<h3 id="snmpdf">snmpdf</h3>

<pre><code class="language-batch">sol@debian:~$ snmpdf -v 1 -c public 157.26.77.13
Description                    size (kB)       Used  Available  Used%
Physical memory                  8185000    6570972    1614028    80%
Virtual memory                  20047012    7191564   12855448    35%
Memory buffers                   8185000     469740    7715260     5%
Cached memory                    2823684    2823684          0   100%
                                       0          0          0     0%
Swap space                      11862012     620592   11241420     5%
/dev                               10240          0      10240     0%
/                               19092180   12343960    6748220    64%
/boot                             233191      38735     194456    16%
/var/lib/lxc                   103081248   35433252   67647996    34%
/var/lib/lxc/15/rootfs/scratch  61796348   32560380   29235968    52%
/sys/fs/cgroup                         0          0          0     0%
/sys/fs/fuse/connections               0          0          0     0%
/backup                        287702408  195458304   92244104    67%
</code></pre>

<p><a href="/00illustrations/labo6/wireshark3.png"><img src="/00illustrations/labo6/wireshark3.png" /></a></p>

<p>J’ai tenté de décripter l’échange qui a un format interessant.</p>

<p>Les 15 premières requêtes sont une “reconnaissance” à la façon <code class="highlighter-rouge">walk</code> et reçoivent en réponse des <code class="highlighter-rouge">int</code> qui correspondent à la valeur du dernier élément de l’<strong>OID</strong> suivant.</p>

<p>Les 14 requêtes suivantes contiennent 4 informations:</p>
<ul>
  <li>une valeur <code class="highlighter-rouge">OctetString</code></li>
  <li>un <code class="highlighter-rouge">int</code> (toujours 1024)</li>
  <li>un élément de la colone <code class="highlighter-rouge">size(kB)</code></li>
  <li>un élément de de la colone <code class="highlighter-rouge">Used</code> sur la même ligne que la valeur <code class="highlighter-rouge">size(kB)</code></li>
</ul>

<p><span style="color:red"> à continuer, ça cloche à partir de la ligne 44 </span></p>

<h2 id="4-questions">4. Questions</h2>

<h3 id="a">a.</h3>
<p>Selon le schéma suivant (<em>architecture de SNMP</em>), identifier chacun des partenaires (qui est celui qui interroge? qui est celui qui répond?).</p>

<p><a href="/00illustrations/labo6/diag1.png"><img src="/00illustrations/labo6/diag1.png" /></a></p>

<ul>
  <li>Le <strong>manager SNMP</strong> envoie des <code class="highlighter-rouge">get - request</code> et <code class="highlighter-rouge">set - request</code> à un <strong>agent SNMP</strong> qui lui répond avec des <code class="highlighter-rouge">get - response</code> <code class="highlighter-rouge">set - response</code> après avoir consulté une <strong>MIB</strong>.</li>
  <li>L’<strong>agent SNMP</strong> peut envoyer des requêtes de type <code class="highlighter-rouge">trap</code> pour généralement signaler un dysfonctionnement.</li>
  <li>Ces échanges se font via le protocole <strong>SNMP</strong></li>
</ul>

<h3 id="b">b.</h3>
<p>Quel est le protocole de couche 4 utilisé? Quel est le numéro de port de l’agent et quel est le numéro de port du manager?</p>

<ul>
  <li>L’agent reçoit des requêtes en <strong>UDP</strong> sur le <strong>port 161</strong></li>
  <li>Le manager peut envoyer des requêtes <strong>UDP</strong> de <strong>n’importe quel port disponible</strong> sur le port 161 de l’agent et la réponse de l’agent se fera sur le port utilisé par le manager.</li>
  <li>Les requêtes de type <code class="highlighter-rouge">trap</code> (et <code class="highlighter-rouge">informRequests</code>) sont envoyées de <strong>n’importe quel port disponible de l’agent</strong> et arrivent sur le <strong>port 162</strong> du manager.</li>
</ul>

<p>Les <strong>PDU</strong> SNMP des captures Wireshark spécifient le protocole <strong>UDP</strong> de plus nous voyons également sur les précédentes captures Wireshark qu’aucune connexion n’est faite avant un échange.</p>

<p><a href="/00illustrations/labo6/udp.png"><img src="/00illustrations/labo6/udp.png" /></a></p>

<p>Précision:</p>
<blockquote>
  <p>Although SNMP works over TCP and other protocols, it is most commonly used over UDP that is connectionless – both for performance reasons, and to minimize the additional load on a potentially troubled network that protocols like TCP impose. The design of the Simple Network Management Protocol was optimized for repairing sick networks, rather than doing heavy things with perfectly healthy ones.</p>
</blockquote>

<p><a href="https://en.wikipedia.org/wiki/Simple_Network_Management_Protocol">en.wikipedia.org</a></p>

<h3 id="c">c.</h3>
<p>Avez-vous eu besoin de vous identiﬁer (donner un login)?</p>
<ul>
  <li>Non</li>
</ul>

<p>De vous authentiﬁer (donner un mot depasse) ?</p>
<ul>
  <li>Non</li>
</ul>

<p>Les données sont-elles en clair?</p>
<ul>
  <li>Oui (pas de cryptage)</li>
</ul>

<p>Existe-t-il un moyen d’améliorer cela avec un agent compatible?</p>
<ul>
  <li>Possibilité de sécuriser avec <code class="highlighter-rouge">SSH</code> (SNMPv3 over SSH) et <code class="highlighter-rouge">TLS</code> et <code class="highlighter-rouge">DTLS</code> (SNMPv3 over TLS/DTLS)</li>
  <li>Il semble que le SNMPv3 over SSH sois récent. Initialement SNMPv3 implentait lui même sa propre couche SSH.</li>
</ul>

<h3 id="d">d.</h3>
<p>Quelles sont les principales requêtes et réponses du protocole?</p>

<ul>
  <li><code class="highlighter-rouge">getRequest</code></li>
  <li><code class="highlighter-rouge">setRequest</code></li>
  <li><code class="highlighter-rouge">getNextRequest</code></li>
  <li><code class="highlighter-rouge">getBulkRequest</code></li>
  <li><code class="highlighter-rouge">Reponse</code></li>
  <li><code class="highlighter-rouge">Trap</code></li>
  <li><code class="highlighter-rouge">InformRequest</code></li>
</ul>

<p>Voir mon <a href="/reseau/reseau-SNMP.html/">article</a> sur le protocole snmp pour plus d’infos</p>

<h3 id="e">e.</h3>
<p>Dans quels champs de la MIB HOST-RESOURCES est-ce que la commande <code class="highlighter-rouge">snmpdf</code> ci-dessus va chercher?</p>

<p><code class="highlighter-rouge">1.3.6.1.2.1.25.2.3.x</code> $ \Rightarrow \; \large x \in  [1,38] $</p>

<div class="highlighter-rouge"><pre class="highlight"><code>sol@debian:~$ snmpwalk -v 1 -c public 157.26.77.13 1.3.6.1.2.1.25.2.3
HOST-RESOURCES-MIB::hrStorageIndex.1 = INTEGER: 1
HOST-RESOURCES-MIB::hrStorageIndex.3 = INTEGER: 3
HOST-RESOURCES-MIB::hrStorageIndex.6 = INTEGER: 6
HOST-RESOURCES-MIB::hrStorageIndex.7 = INTEGER: 7
HOST-RESOURCES-MIB::hrStorageIndex.8 = INTEGER: 8
HOST-RESOURCES-MIB::hrStorageIndex.10 = INTEGER: 10
HOST-RESOURCES-MIB::hrStorageIndex.31 = INTEGER: 31
HOST-RESOURCES-MIB::hrStorageIndex.32 = INTEGER: 32
HOST-RESOURCES-MIB::hrStorageIndex.33 = INTEGER: 33
HOST-RESOURCES-MIB::hrStorageIndex.34 = INTEGER: 34
HOST-RESOURCES-MIB::hrStorageIndex.35 = INTEGER: 35
HOST-RESOURCES-MIB::hrStorageIndex.36 = INTEGER: 36
HOST-RESOURCES-MIB::hrStorageIndex.37 = INTEGER: 37
HOST-RESOURCES-MIB::hrStorageIndex.38 = INTEGER: 38
HOST-RESOURCES-MIB::hrStorageType.1 = OID: HOST-RESOURCES-TYPES::hrStorageRam
HOST-RESOURCES-MIB::hrStorageType.3 = OID: HOST-RESOURCES-TYPES::hrStorageVirtualMemory
HOST-RESOURCES-MIB::hrStorageType.6 = OID: HOST-RESOURCES-TYPES::hrStorageOther
HOST-RESOURCES-MIB::hrStorageType.7 = OID: HOST-RESOURCES-TYPES::hrStorageOther
HOST-RESOURCES-MIB::hrStorageType.8 = OID: HOST-RESOURCES-TYPES::hrStorageOther
HOST-RESOURCES-MIB::hrStorageType.10 = OID: HOST-RESOURCES-TYPES::hrStorageVirtualMemory
HOST-RESOURCES-MIB::hrStorageType.31 = OID: HOST-RESOURCES-TYPES::hrStorageFixedDisk
HOST-RESOURCES-MIB::hrStorageType.32 = OID: HOST-RESOURCES-TYPES::hrStorageFixedDisk
HOST-RESOURCES-MIB::hrStorageType.33 = OID: HOST-RESOURCES-TYPES::hrStorageFixedDisk
HOST-RESOURCES-MIB::hrStorageType.34 = OID: HOST-RESOURCES-TYPES::hrStorageFixedDisk
HOST-RESOURCES-MIB::hrStorageType.35 = OID: HOST-RESOURCES-TYPES::hrStorageFixedDisk
HOST-RESOURCES-MIB::hrStorageType.36 = OID: HOST-RESOURCES-TYPES::hrStorageFixedDisk
HOST-RESOURCES-MIB::hrStorageType.37 = OID: HOST-RESOURCES-TYPES::hrStorageFixedDisk
HOST-RESOURCES-MIB::hrStorageType.38 = OID: HOST-RESOURCES-TYPES::hrStorageFixedDisk
HOST-RESOURCES-MIB::hrStorageDescr.1 = STRING: Physical memory
HOST-RESOURCES-MIB::hrStorageDescr.3 = STRING: Virtual memory
HOST-RESOURCES-MIB::hrStorageDescr.6 = STRING: Memory buffers
HOST-RESOURCES-MIB::hrStorageDescr.7 = STRING: Cached memory
HOST-RESOURCES-MIB::hrStorageDescr.8 = STRING: Shared memory
HOST-RESOURCES-MIB::hrStorageDescr.10 = STRING: Swap space
HOST-RESOURCES-MIB::hrStorageDescr.31 = STRING: /dev
HOST-RESOURCES-MIB::hrStorageDescr.32 = STRING: /
HOST-RESOURCES-MIB::hrStorageDescr.33 = STRING: /boot
HOST-RESOURCES-MIB::hrStorageDescr.34 = STRING: /var/lib/lxc
HOST-RESOURCES-MIB::hrStorageDescr.35 = STRING: /var/lib/lxc/15/rootfs/scratch
HOST-RESOURCES-MIB::hrStorageDescr.36 = STRING: /sys/fs/cgroup
HOST-RESOURCES-MIB::hrStorageDescr.37 = STRING: /sys/fs/fuse/connections
HOST-RESOURCES-MIB::hrStorageDescr.38 = STRING: /backup
HOST-RESOURCES-MIB::hrStorageAllocationUnits.1 = INTEGER: 1024 Bytes
HOST-RESOURCES-MIB::hrStorageAllocationUnits.3 = INTEGER: 1024 Bytes
HOST-RESOURCES-MIB::hrStorageAllocationUnits.6 = INTEGER: 1024 Bytes
HOST-RESOURCES-MIB::hrStorageAllocationUnits.7 = INTEGER: 1024 Bytes
HOST-RESOURCES-MIB::hrStorageAllocationUnits.8 = INTEGER: 1024 Bytes
HOST-RESOURCES-MIB::hrStorageAllocationUnits.10 = INTEGER: 1024 Bytes
HOST-RESOURCES-MIB::hrStorageAllocationUnits.31 = INTEGER: 4096 Bytes
HOST-RESOURCES-MIB::hrStorageAllocationUnits.32 = INTEGER: 4096 Bytes
HOST-RESOURCES-MIB::hrStorageAllocationUnits.33 = INTEGER: 1024 Bytes
HOST-RESOURCES-MIB::hrStorageAllocationUnits.34 = INTEGER: 4096 Bytes
HOST-RESOURCES-MIB::hrStorageAllocationUnits.35 = INTEGER: 4096 Bytes
HOST-RESOURCES-MIB::hrStorageAllocationUnits.36 = INTEGER: 4096 Bytes
HOST-RESOURCES-MIB::hrStorageAllocationUnits.37 = INTEGER: 4096 Bytes
HOST-RESOURCES-MIB::hrStorageAllocationUnits.38 = INTEGER: 4096 Bytes
HOST-RESOURCES-MIB::hrStorageSize.1 = INTEGER: 8185000
HOST-RESOURCES-MIB::hrStorageSize.3 = INTEGER: 20047012
HOST-RESOURCES-MIB::hrStorageSize.6 = INTEGER: 8185000
HOST-RESOURCES-MIB::hrStorageSize.7 = INTEGER: 1998532
HOST-RESOURCES-MIB::hrStorageSize.8 = INTEGER: 0
HOST-RESOURCES-MIB::hrStorageSize.10 = INTEGER: 11862012
HOST-RESOURCES-MIB::hrStorageSize.31 = INTEGER: 2560
HOST-RESOURCES-MIB::hrStorageSize.32 = INTEGER: 4773045
HOST-RESOURCES-MIB::hrStorageSize.33 = INTEGER: 233191
HOST-RESOURCES-MIB::hrStorageSize.34 = INTEGER: 25770312
HOST-RESOURCES-MIB::hrStorageSize.35 = INTEGER: 15449087
HOST-RESOURCES-MIB::hrStorageSize.36 = INTEGER: 0
HOST-RESOURCES-MIB::hrStorageSize.37 = INTEGER: 0
HOST-RESOURCES-MIB::hrStorageSize.38 = INTEGER: 71925602
HOST-RESOURCES-MIB::hrStorageUsed.1 = INTEGER: 5907192
HOST-RESOURCES-MIB::hrStorageUsed.3 = INTEGER: 6526984
HOST-RESOURCES-MIB::hrStorageUsed.6 = INTEGER: 548284
HOST-RESOURCES-MIB::hrStorageUsed.7 = INTEGER: 1998532
HOST-RESOURCES-MIB::hrStorageUsed.10 = INTEGER: 619792
HOST-RESOURCES-MIB::hrStorageUsed.31 = INTEGER: 0
HOST-RESOURCES-MIB::hrStorageUsed.32 = INTEGER: 3089177
HOST-RESOURCES-MIB::hrStorageUsed.33 = INTEGER: 38735
HOST-RESOURCES-MIB::hrStorageUsed.34 = INTEGER: 8858338
HOST-RESOURCES-MIB::hrStorageUsed.35 = INTEGER: 8140095
HOST-RESOURCES-MIB::hrStorageUsed.36 = INTEGER: 0
HOST-RESOURCES-MIB::hrStorageUsed.37 = INTEGER: 0
HOST-RESOURCES-MIB::hrStorageUsed.38 = INTEGER: 49018100
</code></pre>
</div>
<p>Ce qui correspond bien à la capture et au résultat de la commande plus haut.</p>

<h2 id="5-avec-un-logiciel-à-choix-parmis-les-suivants">5. Avec un logiciel à choix parmis les suivants:</h2>

<ul>
  <li><strong>snpwalk</strong> (shell) ou <strong>tkmib</strong> (GUI simpliste) sous Unix</li>
  <li><strong>Open Eyes</strong> sous Java</li>
  <li><strong>getif</strong> sous Windows</li>
  <li><strong><a href="http://www.oidview.com/mibs/detail.html">oidview</a></strong> sur le Net</li>
</ul>

<p>Déterminez, en n’oubliant pas de configurer la destination (nom de l’agent interrogé), ici <code class="highlighter-rouge">157.26.77.13</code>:</p>

<h3 id="a-1">a.</h3>
<p>Le numéro d’identification de l’entrée pointant sur le nombre d’interfaces réseaux (<code class="highlighter-rouge">iso.org.dod.internet.mgmt.mib-2.interfaces</code>),puis obtenez les noms de ses interfaces réseau.</p>

<p>Tkmib nous permet de visualiser les branches après <code class="highlighter-rouge">.interface</code>, leur <strong>OID</strong> en plus d’une descritpion.</p>

<ul>
  <li>Un <code class="highlighter-rouge">get</code> de <code class="highlighter-rouge">.1.3.6.1.2.1.2.1</code> nous retourne le nombre d’interfaces:</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>sol@debian:~$ snmpget -v 1 -c public 157.26.77.13 .1.3.6.1.2.1.2.1.0
IF-MIB::ifNumber.0 = INTEGER: 26
</code></pre>
</div>

<p>cette commande est équivalente à:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>sol@debian:~$ snmpget -v 1 -c public 157.26.77.13 .iso.org.dod.internet.mgmt.mib-2.interfaces.ifNumber.0
IF-MIB::ifNumber.0 = INTEGER: 26

</code></pre>
</div>

<ul>
  <li>La description de Tkmib nous dit que l’entrée suivante contient la liste des interfaces:</li>
</ul>

<p><a href="/00illustrations/labo6/tkmib.png"><img src="/00illustrations/labo6/tkmib.png" /></a></p>

<p>Nous pouvons visualiser le nom des interfacea dans la gui avec un display sous forme de tableau.</p>

<p>Nous pouvons égalment faire un <code class="highlighter-rouge">snmpwalk</code> à la ligne de commande sur le premier élément de cette entrée:</p>

<p><code class="highlighter-rouge">sol@debian:~$ snmpwalk -v 1 -c public 157.26.77.13 .1.3.6.1.2.1.2.2</code></p>

<p>Et voici l’extrais qui nous interesse:</p>
<div class="highlighter-rouge"><pre class="highlight"><code>...
IF-MIB::ifDescr.1 = STRING: lo
IF-MIB::ifDescr.2 = STRING: eth0
IF-MIB::ifDescr.3 = STRING: eth1
IF-MIB::ifDescr.4 = STRING: br0
IF-MIB::ifDescr.6 = STRING: veth11
IF-MIB::ifDescr.8 = STRING: veth15
IF-MIB::ifDescr.10 = STRING: veth151
IF-MIB::ifDescr.12 = STRING: veth152
IF-MIB::ifDescr.14 = STRING: veth153
IF-MIB::ifDescr.16 = STRING: veth154
IF-MIB::ifDescr.18 = STRING: veth155
IF-MIB::ifDescr.20 = STRING: veth156
IF-MIB::ifDescr.22 = STRING: veth157
IF-MIB::ifDescr.24 = STRING: veth158
IF-MIB::ifDescr.26 = STRING: veth159
IF-MIB::ifDescr.28 = STRING: veth160
IF-MIB::ifDescr.30 = STRING: veth161
IF-MIB::ifDescr.32 = STRING: veth162
IF-MIB::ifDescr.34 = STRING: veth163
IF-MIB::ifDescr.36 = STRING: veth164
IF-MIB::ifDescr.38 = STRING: veth165
IF-MIB::ifDescr.40 = STRING: veth166
IF-MIB::ifDescr.42 = STRING: veth167
IF-MIB::ifDescr.46 = STRING: veth169
IF-MIB::ifDescr.48 = STRING: veth170
IF-MIB::ifDescr.50 = STRING: veth168
...
</code></pre>
</div>

<h3 id="b-1">b.</h3>
<p>les informations de l’objet <code class="highlighter-rouge">iso.org.dod.internet.mgmt.mib-2.interfaces.ifTable .ifEntry.ifInOctets</code></p>

<div class="highlighter-rouge"><pre class="highlight"><code>sol@debian:~$ snmpwalk -v 1 -c public 157.26.77.13 .iso.org.dod.internet.mgmt.mib-2.interfaces.ifTable.ifEntry.ifInOctets
IF-MIB::ifInOctets.1 = Counter32: 4170454039
IF-MIB::ifInOctets.2 = Counter32: 623131649
IF-MIB::ifInOctets.3 = Counter32: 0
IF-MIB::ifInOctets.4 = Counter32: 2031979771
IF-MIB::ifInOctets.6 = Counter32: 287160632
IF-MIB::ifInOctets.8 = Counter32: 2470231482
IF-MIB::ifInOctets.10 = Counter32: 55688373
IF-MIB::ifInOctets.12 = Counter32: 84105143
IF-MIB::ifInOctets.14 = Counter32: 17146364
IF-MIB::ifInOctets.16 = Counter32: 114408639
IF-MIB::ifInOctets.18 = Counter32: 24760215
IF-MIB::ifInOctets.20 = Counter32: 47147411
IF-MIB::ifInOctets.22 = Counter32: 21354563
IF-MIB::ifInOctets.24 = Counter32: 43460795
IF-MIB::ifInOctets.26 = Counter32: 31137936
IF-MIB::ifInOctets.28 = Counter32: 57591110
IF-MIB::ifInOctets.30 = Counter32: 40998856
IF-MIB::ifInOctets.32 = Counter32: 158066311
IF-MIB::ifInOctets.34 = Counter32: 117731318
IF-MIB::ifInOctets.36 = Counter32: 29735593
IF-MIB::ifInOctets.38 = Counter32: 31914455
IF-MIB::ifInOctets.40 = Counter32: 98663284
IF-MIB::ifInOctets.42 = Counter32: 93196279
IF-MIB::ifInOctets.46 = Counter32: 2715027
IF-MIB::ifInOctets.48 = Counter32: 1525717
IF-MIB::ifInOctets.50 = Counter32: 299054826
</code></pre>
</div>

<h2 id="6-avancé-experimenter-avec-snmp-traps">6. Avancé: Experimenter avec SNMP traps</h2>

<p>L’outil <code class="highlighter-rouge">snmptrap</code> (ou <code class="highlighter-rouge">snmpinform</code>) permet d’envoyer des <code class="highlighter-rouge">traps</code> à un manager. Le daemon <code class="highlighter-rouge">snmptrapd</code> permet de les recevoir et les traiter.</p>

<h3 id="a-2">a.</h3>

<p>installation de snmptrapd</p>

<h3 id="b-2">b.</h3>

<p><a href="https://manpages.debian.org/jessie/snmp/snmptrap.1.en.html">man</a></p>

<p><code class="highlighter-rouge">snmptrap</code> is an SNMP application that uses the SNMP TRAP operation to <strong>send notifications to a network manager</strong>. 
One or more object identifiers (OIDs) can be given as arguments on the command line. <strong>A type and a value must accompany each object identifier</strong>. Each variable name is given in the format specified in variables(5) (notation à nombres ou notation avec les noms).</p>

<p>When invoked as <code class="highlighter-rouge">snmpinform</code>, <strong>or when -Ci is added to the command line flags of snmptrap</strong>, it sends an INFORM-PDU, <strong>expecting a response from the trap receiver</strong>, retransmitting if required. Otherwise it sends an TRAP-PDU or TRAP2-PDU.</p>

<p><strong>syntaxes:</strong></p>

<div class="highlighter-rouge"><pre class="highlight"><code>snmptrap -v 1 [COMMON OPTIONS] AGENT enterprise-oid agent generic-trap specific-trap uptime [OID TYPE VALUE]...

snmptrap -v [2c|3] [COMMON OPTIONS] [-Ci] AGENT uptime trap-oid [OID TYPE VALUE]...

snmpinform -v [2c|3] [COMMON OPTIONS] AGENT uptime trap-oid [OID TYPE VALUE]...
</code></pre>
</div>

<h3 id="c-1">c.</h3>
<p>Effectuer les opérations suivantes dans deux shells:</p>

<ul>
  <li>
    <p>lancer le <code class="highlighter-rouge">snmptrapd</code> sans configuration mais en mode debug sudo <code class="highlighter-rouge">snmptrapd -f -Le -C -d -D</code></p>
  </li>
  <li>
    <p>envoyez une TRAP (les erreurs read_config_store open sont normales) en capturant (Wireshark ou tcpdump <strong>sur l’interface lo</strong>)</p>
  </li>
</ul>

<p><code class="highlighter-rouge">snmptrap -v 1 -c public localhost system 1.2.3.4 3 0 iso.org.dod.internet.mgmt.mib-2.interfaces.1 i 1</code></p>

<p><a href="/00illustrations/labo6/trap.png"><img src="/00illustrations/labo6/trap.png" /></a></p>

<p><code class="highlighter-rouge">snmpinform</code> attends une réponse du manager alors que <code class="highlighter-rouge">snmptrap</code> envoie juste une notification.</p>

<h1 id="décodage-snmp-asn1ber">Décodage SNMP (ASN.1/BER)</h1>

<ul>
  <li><a href="http://luca.ntop.org/Teaching/Appunti/asn1.html">tuto</a></li>
  <li>
    <p><a href="https://en.wikipedia.org/wiki/X.690#Encoding_structure">x.690</a></p>
  </li>
  <li>[type] + [len data] $ \Rightarrow $  1Byte</li>
  <li>[data] $ \Rightarrow $ lenght of <code class="highlighter-rouge">len data</code>
<br />
<br /></li>
</ul>

<table>
  <thead>
    <tr>
      <th style="text-align: center">type</th>
      <th style="text-align: center">10</th>
      <th style="text-align: center">0x</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">End of content</td>
      <td style="text-align: center">0</td>
      <td style="text-align: center">0</td>
    </tr>
    <tr>
      <td style="text-align: center">bool</td>
      <td style="text-align: center">1</td>
      <td style="text-align: center">1</td>
    </tr>
    <tr>
      <td style="text-align: center">int</td>
      <td style="text-align: center">2</td>
      <td style="text-align: center">02</td>
    </tr>
    <tr>
      <td style="text-align: center">bit string</td>
      <td style="text-align: center">3</td>
      <td style="text-align: center">03</td>
    </tr>
    <tr>
      <td style="text-align: center">octet string</td>
      <td style="text-align: center">4</td>
      <td style="text-align: center">04</td>
    </tr>
    <tr>
      <td style="text-align: center">NULL</td>
      <td style="text-align: center">5</td>
      <td style="text-align: center">05</td>
    </tr>
    <tr>
      <td style="text-align: center">Object identifier</td>
      <td style="text-align: center">6</td>
      <td style="text-align: center">06</td>
    </tr>
    <tr>
      <td style="text-align: center">sequence and seq of</td>
      <td style="text-align: center">16</td>
      <td style="text-align: center">10</td>
    </tr>
    <tr>
      <td style="text-align: center">set and set of</td>
      <td style="text-align: center">17</td>
      <td style="text-align: center">11</td>
    </tr>
    <tr>
      <td style="text-align: center">printable string</td>
      <td style="text-align: center">19</td>
      <td style="text-align: center">13</td>
    </tr>
    <tr>
      <td style="text-align: center">T61String</td>
      <td style="text-align: center">20</td>
      <td style="text-align: center">14</td>
    </tr>
    <tr>
      <td style="text-align: center">IA5String</td>
      <td style="text-align: center">22</td>
      <td style="text-align: center">16</td>
    </tr>
    <tr>
      <td style="text-align: center">UTCTime</td>
      <td style="text-align: center">23</td>
      <td style="text-align: center">17</td>
    </tr>
    <tr>
      <td style="text-align: center">VisibleString</td>
      <td style="text-align: center">26</td>
      <td style="text-align: center">1a</td>
    </tr>
    <tr>
      <td style="text-align: center">Struct</td>
      <td style="text-align: center">48</td>
      <td style="text-align: center">30</td>
    </tr>
  </tbody>
</table>

<p><br />
<br /></p>

<hr />

<div class="highlighter-rouge"><pre class="highlight"><code>30 2d 02 01 00 04 06 70 75 62 6c 69 63 a1 20 02
04 22 2d 9d d6 02 01 00 02 01 00 30 12 30 10 06
0c 2b 06 01 02 01 2b 0e 01 01 06 01 01 05 00
</code></pre>
</div>

<ul>
  <li><strong>type</strong>: 30 $ \Rightarrow $ type construit (Sequence aussi ? d’arès ce que je crois comprendre dans votre mail)</li>
  <li><strong>len</strong>: $ 0x2d = 45_{10} (+2) $</li>
  <li><strong>data</strong>: tout le reste
<br /></li>
</ul>

<hr />

<p><code class="highlighter-rouge">02 01</code></p>

<ul>
  <li><strong>type</strong>: 02 $ \Rightarrow $ <code class="highlighter-rouge">int</code></li>
  <li><strong>len</strong>: $ 0x01 (+2) =  1_{10} (+2) $</li>
  <li><strong>data</strong>: <code class="highlighter-rouge">00</code> $ \Rightarrow 0_{10} $
<br /></li>
</ul>

<hr />

<p><code class="highlighter-rouge">04 06 70 75 62 6C 69 63</code></p>

<ul>
  <li><strong>type</strong>: 5 $ \Rightarrow $ <code class="highlighter-rouge">octet string</code></li>
  <li><strong>len</strong>: $ 0x06 (+2) = 6_{10} (+2) $</li>
  <li><strong>data</strong>: `` $ \Rightarrow $ <code class="highlighter-rouge">70 75 62 6C 69 63</code></li>
</ul>

<p>Conversion string $ \Rightarrow $  char:</p>

<div class="language-py highlighter-rouge"><pre class="highlight"><code><span class="n">s</span> <span class="o">=</span> <span class="s">"70 75 62 6C 69 63"</span>
<span class="n">l</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
    <span class="n">r</span> <span class="o">=</span> <span class="s">r'{10}'</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"$ 0x{} = {}_{} = {} $"</span>\
        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">r</span><span class="p">,</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">))))</span>

<span class="p">[</span><span class="k">print</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s">''</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">l</span><span class="p">]</span>
</code></pre>
</div>

<p><br /></p>

<table>
  <tbody>
    <tr>
      <td>0x112</td>
      <td>$112_{10}$</td>
      <td>$p$</td>
    </tr>
    <tr>
      <td>0x117</td>
      <td>$117_{10}$</td>
      <td>$u$</td>
    </tr>
    <tr>
      <td>0x98</td>
      <td>$98_{10}$</td>
      <td>$b$</td>
    </tr>
    <tr>
      <td>0x108</td>
      <td>$108_{10}$</td>
      <td>$l$</td>
    </tr>
    <tr>
      <td>0x105</td>
      <td>$105_{10}$</td>
      <td>$i$</td>
    </tr>
    <tr>
      <td>0x99</td>
      <td>$99_{10}$</td>
      <td>$c$</td>
    </tr>
  </tbody>
</table>

<p><br /></p>

<p>$ \Large \Rightarrow  public $</p>

<hr />

<div class="highlighter-rouge"><pre class="highlight"><code>a1 20 02
04 22 2d 9d d6 02 01 00 02 01 00 30 12 30 10 06
0c 2b 06 01 02 01 2b 0e 01 01 06 01 01 05 00
</code></pre>
</div>

<ul>
  <li><strong>type</strong>: $ 0xA1 \Rightarrow $ Sequence</li>
  <li><strong>len</strong>: $ 0x20 = 32_{10} (+2) $</li>
  <li><strong>data</strong>: tout le reste
<br /></li>
</ul>

<hr />

<p><code class="highlighter-rouge">02 04 22 2d 9d d6</code></p>

<ul>
  <li><strong>type</strong>:  $0x02 \Rightarrow $ <code class="highlighter-rouge">int</code></li>
  <li><strong>len</strong>:  $ 0x04 (+2) = 4 (+2)</li>
  <li><strong>data</strong>: $ 0x222d9dd6  \Rightarrow  573414870_{10} $
<br /></li>
</ul>

<hr />

<p><code class="highlighter-rouge">02 01 00</code></p>

<ul>
  <li><strong>type</strong>: $ 0x02  \Rightarrow $ <code class="highlighter-rouge">int</code></li>
  <li><strong>len</strong>: $0x01 (+2) = 1 (+2) $</li>
  <li><strong>data</strong>: $ 0x00 \Rightarrow 0_{10} $
<br /></li>
</ul>

<hr />

<p><code class="highlighter-rouge">02 01 00</code></p>

<ul>
  <li><strong>type</strong>: $ 0x02 \Rightarrow $ <code class="highlighter-rouge">int</code></li>
  <li><strong>len</strong>: $0x01 (+2) = 1 (+2) $</li>
  <li><strong>data</strong>: $ 0x00 \Rightarrow 0_{10} $
<br /></li>
</ul>

<hr />

<p><code class="highlighter-rouge">30 12</code></p>

<ul>
  <li><strong>type</strong>:  $ 0x30 \Rightarrow $ type construit</li>
  <li><strong>len</strong>:  $ 0x12 (+2) = 18 (+2)</li>
  <li><strong>data</strong>: tout le reste
<br /></li>
</ul>

<hr />

<p><code class="highlighter-rouge">30 10</code></p>

<ul>
  <li><strong>type</strong>:  $ 0x30 \Rightarrow $ type construit</li>
  <li><strong>len</strong>:  $ 0x10 (+2) = 16 (+2)</li>
  <li><strong>data</strong>: tout le reste
<br /></li>
</ul>

<hr />

<p><code class="highlighter-rouge">06 0c 2b 06 01 02 01 2b 0e 01 01 06 01 01</code></p>

<ul>
  <li><strong>type</strong>:  $ 0x06 \Rightarrow $ objet</li>
  <li><strong>len</strong>:  $ 0x0c (+2) = 12 (+2)</li>
  <li><strong>data</strong>: <code class="highlighter-rouge">2b 06 01 02 01 2b 0e 01 01 06 01 01</code></li>
</ul>

<p>Après avoir regardé quelques trames des captures je reconnais <code class="highlighter-rouge">.6.1.2.1</code> (…DoD.Internet.management.MIB-2.) mais il manque le début <code class="highlighter-rouge">.1.3.</code> qui est remplacé par <code class="highlighter-rouge">2b</code>. Après vérification sur <strong>Tkmib</strong> <code class="highlighter-rouge">.43</code> n’existe pas mais cela ne veur rien dire, nous somme peut être dans une MIB qui possède ce <code class="highlighter-rouge">.43</code>. Sans certitude j’ai envie de dire que ce champ veut dire: <code class="highlighter-rouge">1.3.6.1.2.1.43.14.1.1.6.1.1</code>
<br /></p>

<hr />

<p><code class="highlighter-rouge">05 00</code></p>

<ul>
  <li><strong>type</strong>:  $ 0x05 \Rightarrow $ NULL</li>
  <li><strong>len</strong>:  $ 0x00 (+2) = 0_{10} (+2) $</li>
  <li><strong>data</strong>: NULL
<br /></li>
</ul>

<hr />

<h4 id="tentative-de-mise-sous-forme-asn1">Tentative de mise sous forme ASN.1</h4>

<div class="highlighter-rouge"><pre class="highlight"><code>TYPE CONSTRUIT {
    INTEGER {
        version-1{0}
    },

    OCTET STRING {
        community{public}
    },
    SEQUENCE {
        INTEGER {
            573414870  -- ip? (ça peut être une ip dans un autre format?)
        },
        INTEGER {
            0
        },
        INTEGER {
            0
        },
        TYPE CONSTRUIT {
            TYPE CONSTRUIT {
                OBJECT IDENTIFIER {
                    1.3.6.1.2.1.43.14.1.1.6.1.1
                },
                NULL
                }
            }
        }
    }
}
</code></pre>
</div>

<h1 id="configuration-dun-agent-snmp">Configuration d’un agent SNMP</h1>

<ul>
  <li>installer un agent (daemon)</li>
  <li>configurer quelques éléments de sécurité basique et autoriser la modification de données</li>
</ul>

<h2 id="1-installation-de-snmpd">1. Installation de snmpd</h2>
<p>ok</p>

<h2 id="2-consulter-le-fichier-etcsnmpsnmpdconf">2. Consulter le fichier /etc/snmp/snmpd.conf</h2>
<p>Chmod à faire !</p>

<h2 id="3-adapter-des-données-dans-ce-fichier-et-tester-avec-snmpwalk--questions">3. Adapter des données dans ce fichier et tester avec snmpwalk + questions</h2>

<div class="highlighter-rouge"><pre class="highlight"><code>sol@debian:/etc/snmp$ snmpwalk -v 1 -c public localhost .1.3.6.1.2.1.1
SNMPv2-MIB::sysDescr.0 = STRING: Linux debian 3.16.0-4-amd64 #1 SMP Debian 3.16.43-2 (2017-04-30) x86_64
SNMPv2-MIB::sysObjectID.0 = OID: NET-SNMP-MIB::netSnmpAgentOIDs.10
...
...
</code></pre>
</div>
<h3 id="a-3">a.</h3>
<p>Qu’est-ce qu’une communauté ? Comment protéger (un peu) votre agent SNMP?</p>

<ul>
  <li>Les <strong>communautés</strong>  (v1,2) permettent de filtrer l’accès aux informations d’une <strong>MIB</strong>
    <ul>
      <li><code class="highlighter-rouge">public</code> $ \Rightarrow $  lecture seule (default)</li>
      <li><code class="highlighter-rouge">private</code> $ \Rightarrow $ donne accès à toute la configuration système en lecture/écriture</li>
    </ul>
  </li>
</ul>

<blockquote>
  <p>Généralement, lors d’un déploiement de SNMPv1 et SNMPv2, aucune technique de sécurisation de ces protocoles n’est réalisée car aucun mécanisme ne le permet réellement. Alors, la sécurisation en périphérie du protocole doit être réalisée (filtrage à différents niveaux, mécanisme anti-spoofing, …).</p>
</blockquote>

<p><a href="https://blog.cedrictemple.net/341-configuration-avancee-de-snmp-sur-linux-snmpv3">source</a></p>

<p>SNMPv3 permet de répondre à ces problèmes.</p>
<ol>
  <li>les trames peuvent être chiffrées grâce à différents algorithmes</li>
  <li>de utilisateurs peuvent être créés, chacun disposant d’un identifiant et d’un mot de passe personnel.</li>
</ol>

<h3 id="b-3">b.</h3>
<p>Activer un nom de communauté permettant de modifier la configuration et modifiez le nom de la machine.</p>

<p><span style="color:red"> à finir </span></p>

<h1 id="conception-dune-application-simple-python">Conception d’une application simple Python</h1>

<ul>
  <li>Faire un petit graph Web de statistiques d’un équipement réseau via SNMP</li>
  <li>Librairies nécéssaires:
    <ul>
      <li><code class="highlighter-rouge">PySNMP</code></li>
      <li><code class="highlighter-rouge">http.server</code></li>
      <li><code class="highlighter-rouge">matPlotLib</code></li>
    </ul>
  </li>
</ul>

<p>L’application interrogera un équipement par protocole <strong>SNMP</strong> et répondra sur le port 80 en <strong>HTTP</strong>. L’application supportera une seule fonction qui retourne un document au format <strong>MIME</strong> (image/svg+xml) qui sera affichée par le navigateur.</p>

<h2 id="délivrable">Délivrable</h2>

<h3 id="architecture-de-lapplication">Architecture de l’application</h3>

<p><a href="/00illustrations/labo6/diag2.png"><img src="/00illustrations/labo6/diag2.png" /></a>
<br /></p>

<h3 id="diagrammes-dinteraction-avec-le-client-http-et-léquipement-snmp">Diagrammes d’interaction avec le client <strong>HTTP</strong> et l’équipement <strong>SNMP</strong></h3>

<p><br />
<a href="/00illustrations/labo6/diag3.png"><img src="/00illustrations/labo6/diag3.png" /></a></p>

<h1 id="mise-en-place-de-docker">Mise en place de Docker</h1>

<p><a href="/00illustrations/labo6/docker.png"><img src="/00illustrations/labo6/docker.png" /></a>
<br />
<br />
<a href="/00illustrations/labo6/docker2.png"><img src="/00illustrations/labo6/docker2.png" /></a></p>

<h1 id="codage-et-test-de-la-solution-programme-python">Codage et test de la solution (Programme Python)</h1>

<p>Notre programme est composé de trois fichiers. Deux modules et un “main”. Il affiche un graph qui représente les processus actifs sur la machine à l’adresse <code class="highlighter-rouge">157.26.77.13</code> en fonction du temps. Ce graph est naj toutes les 3 secondes.</p>

<p>Une fois le serveur lancé il suffit d’ouvir <code class="highlighter-rouge">http://localhost:8000/graph</code> dans un navigateur</p>

<h2 id="datagraphpy">dataGraph.py</h2>

<ul>
  <li>
    <p><code class="highlighter-rouge">getData()</code> $ \Rightarrow $ pull la donnée pointée par l’<strong>OID</strong> <code class="highlighter-rouge">1.3.6.1.2.1.25.1.6</code> de l’agent <strong>SNMP</strong> sur la machine <code class="highlighter-rouge">157.26.77.13</code>.</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">graphPlot()</code> $ \Rightarrow $ traite le fichier <code class="highlighter-rouge">data.txt</code> et retourne un plot dans un fichier <code class="highlighter-rouge">svg</code></p>
  </li>
</ul>

<div class="language-py highlighter-rouge"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pysnmp.smi.view</span> <span class="kn">import</span> <span class="n">MibViewController</span>
<span class="kn">from</span> <span class="nn">pysnmp.hlapi</span>    <span class="kn">import</span> <span class="o">*</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>


<span class="k">def</span> <span class="nf">getData</span><span class="p">():</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">ObjectType</span><span class="p">(</span>
				<span class="n">ObjectIdentity</span><span class="p">(</span><span class="s">'1.3.6.1.2.1.25.1.6'</span><span class="p">)</span>
			<span class="p">)</span>

	<span class="n">g</span> <span class="o">=</span> <span class="n">nextCmd</span> <span class="p">(</span>
			<span class="n">SnmpEngine</span><span class="p">(),</span>
			<span class="n">CommunityData</span><span class="p">(</span><span class="s">'public'</span><span class="p">,</span> <span class="n">mpModel</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
			<span class="n">UdpTransportTarget</span><span class="p">((</span><span class="s">'157.26.77.13'</span><span class="p">,</span> <span class="mi">161</span><span class="p">)),</span>
			<span class="n">ContextData</span><span class="p">(),</span>
			<span class="n">data</span>
		<span class="p">)</span>
	
	<span class="n">errorIndication</span><span class="p">,</span> <span class="n">errorStatus</span><span class="p">,</span> <span class="n">errorIndex</span><span class="p">,</span> <span class="n">varBinds</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
	<span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">varBinds</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">graphPlot</span><span class="p">():</span>
	<span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'data.txt'</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span>
	<span class="n">tab</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">' '</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">file</span><span class="p">]</span>

	<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">180</span><span class="p">)</span>
	<span class="n">plt</span><span class="o">.</span><span class="n">hold</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

	<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span> 
		<span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tab</span><span class="p">],</span>
		<span class="p">[</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">tab</span><span class="p">],</span>
		<span class="s">'r'</span><span class="p">,</span> 
		<span class="n">label</span><span class="o">=</span><span class="s">r'$ running </span><span class="err">\</span><span class="s">; process </span><span class="err">\</span><span class="s">; ({}) $'</span>\
			<span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tab</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">tab</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
	<span class="p">)</span>

	<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
	<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">r'$Time (t)$'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
	<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">r'$Active Process$'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
	<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">'activeProcess(t)'</span><span class="p">);</span>

	<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">'graph.svg'</span><span class="p">)</span>
	<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s">'all'</span><span class="p">)</span>
	<span class="nb">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

</code></pre>
</div>

<h2 id="httpservpy">httpServ.py</h2>
<p>Partie réseau du programme</p>

<div class="language-py highlighter-rouge"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">http.server</span>  <span class="kn">as</span> <span class="nn">hs</span>
<span class="kn">import</span> <span class="nn">socketserver</span> <span class="kn">as</span> <span class="nn">ss</span>
<span class="kn">import</span> <span class="nn">threading</span>


<span class="k">class</span> <span class="nc">MyHttpServer</span><span class="p">(</span><span class="n">hs</span><span class="o">.</span><span class="n">BaseHTTPRequestHandler</span><span class="p">):</span>
	<span class="k">def</span> <span class="nf">do_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
		<span class="n">filedir</span> <span class="o">=</span> <span class="s">""</span>

		<span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">==</span><span class="s">"/graph"</span><span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">'Content-type'</span><span class="p">,</span><span class="s">'text-html'</span><span class="p">)</span>
			<span class="n">filedir</span> <span class="o">=</span> <span class="s">"graph.html"</span>

		<span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">==</span><span class="s">"/graph.svg"</span><span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">'Content-type'</span><span class="p">,</span><span class="s">'image/svg+xml'</span><span class="p">)</span>
			<span class="n">filedir</span> <span class="o">=</span> <span class="s">"graph.svg"</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">'Content-type'</span><span class="p">,</span><span class="s">'image/svg+xml'</span><span class="p">)</span>
			<span class="n">filedir</span> <span class="o">=</span> <span class="s">"error.svg"</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
		<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filedir</span><span class="p">)</span>

		<span class="k">while</span><span class="p">(</span><span class="n">f</span> <span class="o">==</span> <span class="bp">False</span><span class="p">):</span>
			<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
			<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filedir</span><span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="s">'UTF-8'</span><span class="p">))</span>
		<span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">ThreadedHTTPServer</span><span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">ThreadingMixIn</span><span class="p">,</span> 
                         <span class="n">hs</span><span class="o">.</span><span class="n">HTTPServer</span><span class="p">):</span>
	<span class="s">"""#Start HTTPServer in a thread"""</span>
</code></pre>
</div>

<h2 id="softpy">soft.py</h2>
<p>le “main” où sont importé les deux autres fichiers (modules) et est lancé le serveur</p>

<div class="language-py highlighter-rouge"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">httpServ</span>  <span class="kn">as</span> <span class="nn">hs</span>
<span class="kn">import</span> <span class="nn">dataGraph</span> <span class="kn">as</span> <span class="nn">dg</span>


<span class="k">def</span> <span class="nf">closing</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="nb">file</span><span class="p">):</span>
	<span class="nb">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
	<span class="n">server</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>



<span class="n">PORT</span> <span class="o">=</span> <span class="mi">8000</span>
<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'data.txt'</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">try</span><span class="p">:</span>
	<span class="n">serv</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">ThreadedHTTPServer</span><span class="p">(</span>
				<span class="p">(</span><span class="s">'localhost'</span><span class="p">,</span> <span class="n">PORT</span><span class="p">),</span> 
				<span class="n">hs</span><span class="o">.</span><span class="n">MyHttpServer</span>
			<span class="p">)</span>

	<span class="k">print</span><span class="p">(</span><span class="s">"Serving at port"</span><span class="p">,</span> <span class="n">PORT</span><span class="p">)</span>
	
	<span class="n">serverThread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span>\
		<span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">serv</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">)</span>

	<span class="n">serverThread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

	<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
		<span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'data.txt'</span><span class="p">,</span> <span class="s">'a'</span><span class="p">)</span>
		<span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">"{} {}{}"</span><span class="o">.</span>\
			<span class="n">format</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">dg</span><span class="o">.</span><span class="n">getData</span><span class="p">(),</span> <span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">))</span>
			
		<span class="nb">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
		<span class="n">dg</span><span class="o">.</span><span class="n">graphPlot</span><span class="p">()</span>
		<span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
		<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="k">except</span> <span class="nb">KeyboardInterrupt</span><span class="p">:</span>
	<span class="n">closing</span><span class="p">(</span><span class="n">serv</span><span class="p">,</span><span class="n">f</span><span class="p">)</span>

<span class="n">closing</span><span class="p">(</span><span class="n">serv</span><span class="p">,</span><span class="n">f</span><span class="p">)</span>
</code></pre>
</div>


</div>

<div>
	
	<div class="tbc"></div>
	
</div>

<!--<div class="share">
    <p>Share this post with: </p>
	<a href="https://twitter.com/intent/tweet?text=Reseau: Labo 6 SNMP & Docker@&amp;url=http://localhost:4000/reseau/reseau-Labo-6-SNMP.html" class="twitter-share">
		<span class="fa-stack fa-lg">
			<i class="fa fa-circle fa-stack-2x"></i>
			<i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
		</span>
	</a>
    
	<a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/reseau/reseau-Labo-6-SNMP.html" class="facebook-share">
		<span class="fa-stack fa-lg">
			<i class="fa fa-circle fa-stack-2x"></i>
			<i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
		</span>
	</a>
    
	<a href="https://plus.google.com/share?url=http://localhost:4000/reseau/reseau-Labo-6-SNMP.html" class="googleplus-share">
		<span class="fa-stack fa-lg">
			<i class="fa fa-circle fa-stack-2x"></i>
			<i class="fa fa-google-plus fa-stack-1x fa-inverse"></i>
		</span>
	</a>
</div>
-->

<div id="disqus_thread"></div>


 
</div>


</article>

        </div>

    </body>

<footer class="site-footer">
    <div class="wrapper">
        <center>
            <p>
                <a class="link" href="/%20/">Home</a> /
                <a class="link" href="/archive/">Archive</a> /
                <a class="link" href="/category/">Category</a> /
                <a class="link" href="/tags/">Tags</a> /
                <a class="link" href="/about/">About</a> /
                <a class="link" href="/contact/">Contact</a>
            </p>
            <span><script>document.write(new Date().getFullYear());</script></span>
            <span>&copy;</span>

            <a href="mailto:sol.rosca@gmail.com?subject=Hello&nbsp;RoscaS"> RoscaS</a>
            <br>
        </center>
    </div>
</footer>

<foot>
    <foot>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Derictory -->

  <script src="http://code.jquery.com/jquery-1.7.2.min.js"></script>
  <script src="http://yandex.st/highlightjs/6.2/highlight.min.js"></script>

<!-- Hit analytics -->

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<!-- Directory -->

<script src="/js/main.js"></script>

</foot>

</foot>

</html>
