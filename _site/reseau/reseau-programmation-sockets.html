<!DOCTYPE html>
<html>

    <head>
        <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- CSS -->

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://localhost:4000/reseau/reseau-programmation-sockets.html">
  <link rel="alternate" type="application/rss+xml" title="RoscaS" href="http://localhost:4000/feed.xml">

<!-- JS -->
  <!-- <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script> -->
  <script src="/js/mermaid.min.js"></script>

</head>


        
          <script>
	  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
			  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    
  ga('create', 'UA-99742998-1', 'auto');
  ga('send', 'pageview');
    
	</script>


        

        
    </head>

    <body>
        <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Reseau: Programmation sockets (tuto)</title>
  <meta name="description" content="Programmation de sockets">
</head>


        <div class="wrapper">
            <header class="post-header">
	

    <center>
		<div class="post-title" itemprop="name headline">Reseau: Programmation sockets (tuto)</div>

		<div class="post-meta"><i class="fa fa-calendar-o"></i> <time datetime="24 May 2017" itemprop="datePublished">May 24 2017</time>

			&nbsp;&nbsp;•&nbsp;&nbsp;<i class="fa fa-user-secret"></i> <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Sol</span>
        	
			<br>
			<i class="fa fa-eye"></i> <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-pulse"></i></span>clicks</span>
		</div>

        	
        <div class="post-tags">
        	
			<a class="post-tags-item" href="http://localhost:4000/tags/">reseau</a>
        	
			<a class="post-tags-item" href="http://localhost:4000/tags/">sockets</a>
        	
			<a class="post-tags-item" href="http://localhost:4000/tags/">couche4</a>
        	
			<a class="post-tags-item" href="http://localhost:4000/tags/">tcp</a>
        	
			<a class="post-tags-item" href="http://localhost:4000/tags/">udp</a>
        	
			<a class="post-tags-item" href="http://localhost:4000/tags/">Cpp</a>
        	
			<a class="post-tags-item" href="http://localhost:4000/tags/">fr</a>
        	
			
		</div>
    </center>

<div class="wrapper">

    <center>      
		<p>
			<a class="link" href="/">Home</a> /
			<a class="link" href="/archive/">Archive</a> /
			<a class="link" href="/category/">Category</a> / 
			<a class="link" href="/tags/">Tags</a> / 
			<a class="link" href="/about/">About</a> /
			<a class="link" href="/contact/">Contact</a>
    	</p>
    </center>
</div>
    
</header>

<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
<div class="post-content">
    <center>
	
	<p>tuto pratique</p>
	
    </center>
	<h2>Directory</h2>
</div>

<div id="category"></div>

<div class="post-content" itemprop="articleBody">
    <h1 id="programmation-de-sockets">Programmation de sockets</h1>

<h2 id="ressources">ressources:</h2>
<p><a href="http://cvs.alphanet.ch/cgi-bin/cvsweb/~checkout~/schaefer/public/cours/HE-ARC/DECOUVERTE-OS-et-RESEAUX/script/code/client-TCP/donnee/RELEASES/simple-client.tar.gz?rev=HEAD;content-type=application%2Fx-gzip">simple-client.c (base)</a><br />
<a href="http://fs.teleinf.labinfo.eiaj.ch/samba/scratch/RVO/compilation-c-socket.mp4">video explicative</a><br />
<a href="http://broux.developpez.com/articles/c/sockets/">tuto sockets</a> <br />
<a href="http://www.binarytides.com/socket-programming-c-linux-tutorial/">second tuto sockets</a><br />
<a href="https://www.inetdoc.net/dev/socket-c-4and6/socket-c-4and6.getaddrinfo.html">addrinfo</a><br />
<a href="http://manpagesfr.free.fr/man/man3/getaddrinfo.3.html">manPage addrinfo</a><br />
<a href="http://beej.us/guide/bgnet/">fameux Beej’s guide to network programming</a><br />
<a href="http://vidalc.chez.com/lf/socket.html">Le même mais traduit en français</a>  <br />
<a href="https://www.tutorialspoint.com/unix_sockets/index.htm">tutorialsPoint</a><br />
<a href="https://www.tutorialspoint.com/unix_sockets/socket_summary.htm">best</a></p>

<h1 id="quest-ce-quun-socket">Qu’est-ce qu’un socket?</h1>

<p>Un socket autorise la communication entre deux process différents.</p>
<ul>
  <li>Sur la même machine</li>
  <li>Entre des machines distantes</li>
</ul>

<p>Sur Unix, toutes les actions I/O sont faites en écrivant ou en lisant un <strong>descripteur de fichier</strong>.</p>

<blockquote>
  <p>L’entrée standard STDIN, la sortie standard STDOUT et l’erreur standard STDERR sont les trois descripteurs de fichier POSIX standard pour tout processus qui n’est pas un <em>daemon</em>.<br />
<a href="https://fr.wikipedia.org/wiki/Descripteur_de_fichier">wikipedia: descripteur de fichiers</a></p>
</blockquote>

<p>Un <strong>descripteur de fichier</strong> est un entier <code class="highlighter-rouge">int</code> associé avec un <strong>fichier ouvert</strong>. Ce fichier peut être:</p>
<ul>
  <li>Une connexion réseau</li>
  <li>Un fichier texte</li>
  <li>Un terminal</li>
  <li>…</li>
</ul>

<p>D’un point de vue programmatique, un socket ressemble et se comporte comme un descripteur de fichier. On utilise sur lui des fonctions comme <code class="highlighter-rouge">read()</code> et <code class="highlighter-rouge">write()</code> qui fonctionnent de la même façon avec un socket que sur des fichiers ou sur des pipes.</p>

<h1 id="2-contexte-dutilisation">2. Contexte d’utilisation</h1>

<p>Un socket Unix est utilisé dans un contexte <strong>client-serveur</strong>.
Un <strong>Serveur</strong> est un process qui effectue des actions (fonctions) à la demande d’un <strong>client</strong>. La plupart des protocoles de la couche application (FTP, SMTP, POP3…) utilisent des sockets pour:</p>

<ol>
  <li>établir une connexion entre client et serveur</li>
  <li>échager des donnnées</li>
</ol>

<h1 id="3-types-de-sockets">3. Types de sockets</h1>

<p>types de sockets sont disponible pour les utilisateurs.</p>

<p>Stream Sockets (<strong>TCP</strong>)</p>
<ul>
  <li>fiables</li>
  <li>orienté connexion</li>
  <li>pas de limite de taille</li>
  <li>message d’erreur en cas d’échec de l’envoi</li>
</ul>

<p>Datagram Sockets (<strong>UDP</strong>)</p>
<ul>
  <li>non-fiable</li>
  <li>non-orienté connexion (pas de phase connexion comme en TCP,  construction d’un paquet avec les coordonnées de la destination et puis envoi)</li>
</ul>

<p>Raw Sockets</p>
<ul>
  <li>utilisés dans le developpement de protocoles de communication …</li>
  <li>… et le <a href="https://fr.wikipedia.org/wiki/Berkeley_sockets">hacking</a></li>
</ul>

<p>Les process sont théoriquement censés communiquer uniquement entre sockets de même type mais il n’y a aucune restriction qui empêche la communication entre sockets de type différent.</p>

<h1 id="4-modèle-client-server">4. Modèle “Client Server”</h1>
<p>La majorité des applications d’Internet utilisent ce Modèle il se réfère à:
Deux process ou deux applications qui communiquent en échangeant des informations. L’un des deux process agit comme un client et l’autre comme un serveur.</p>

<h3 id="processus-client">Processus Client</h3>
<p>Typiquement celui qui fait  la requête d’informations. Après avoir reçu la résponse, ce process soit se termine soit continue à faire des traitements.</p>

<p><strong>exemple</strong>: Un navigateur internet est une application <strong>client</strong> qui envoie une requête à un serveur Web pour recevoir une page HTML.</p>

<h3 id="processus-serveur">Processus Serveur</h3>
<p>C’est le process qui reçoit les requêtes de la part des clients. Après avoir reçu une requête d’un client, ce process va effectuer le traitement demandé (rassembler des informations, et les renvoyer au client). Une fois ces taches éffectuées le process est disponible pour servir un autre client. <strong>Les process serveurs sont toujours prêts à servir les requêtes qui leurs parviennent</strong>.</p>

<p><strong>exemple</strong>: Un serveur web est toujours entrain d’attendre des requêtes de navigateurs internet. Aussi tôt qu’un client (navigateur) lui fait parvenir une requête, il lui renvoie la page demandée.</p>

<blockquote>
  <p>Un client a besoin de connaitre l’adresse d’un serveur mais pas l’inverse.</p>
</blockquote>

<h3 id="types-de-serveurs">Types de serveurs</h3>

<ul>
  <li>
    <p>Serveurs <strong>itératifs</strong>: forme la plus simple. Le serveur gère un client à la fois et les clients attendent pour s’y connecter.</p>
  </li>
  <li>
    <p>Serveurs <strong>concurents (Concurrent(en))</strong>: gènre plusieurs processus en parallèle et permet de servire plusieurs requêtes à la fois. La forme la plus simple pour implémenter un serveur concurent sous Unix est de <strong>FORKER</strong> un processus enfant pour prendre en charge chaque client.</p>
  </li>
</ul>

<h3 id="interaction-entre-client-et-serveur">Interaction entre client et serveur</h3>
<p>Ce schéma décrit l’intéraction complète entre un client et un serveur.</p>

<p><img src="/00illustrations/socket2/diag1.png" height="auto" /></p>

<h1 id="5-client-http">5. Client HTTP</h1>

<h3 id="a-création-de-socket">a. Création de socket</h3>

<p>La première chose à faire est de créer un socket. C’est le rôle de la fonction <code class="highlighter-rouge">socket</code>.</p>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="cp">#include&lt;stdio.h&gt;
#include&lt;sys/socket.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> 
<span class="p">{</span>
    <span class="c1">// variables
</span>    <span class="kt">int</span> <span class="n">socket_desc</span><span class="p">;</span>
    <span class="n">socket_desc</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">socket_desc</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> 
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Could not create socket"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>
<p>La fonction <code class="highlighter-rouge">socket()</code> crée un socket et retourne un descripteur qui peut être utilisé dans d’autres fonctions. Le code précédent crée un socket avec les propriétés suivantes:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Address Family - AF_INET (ipv4)
Type - SOCK_STREAM (protocol TCP)
Protocol - 0 [ou IPPROTO_IP c'est le protocol IP]
</code></pre>
</div>

<blockquote>
  <ul>
    <li>type <code class="highlighter-rouge">SOCK_STREAM</code> désigne TCP</li>
    <li>type <code class="highlighter-rouge">SOCK_DGRAM</code> désigne UDP</li>
  </ul>
</blockquote>

<h3 id="b-connecter-un-socket-à-un-serveur">b. Connecter un socket à un serveur</h3>

<p>Pour se connecter à un serveur nous avons donc besoins de deux choses:</p>

<ul>
  <li>adresse IP</li>
  <li>numéro de port</li>
</ul>

<p>Pour se connecter à un serveur <strong>distant</strong> il nous faut également d’autres choses.
La première est de créer une structure <code class="highlighter-rouge">sockaddr_in</code> avec les bonnes valeures:</p>

<p>Voici à quoi ressemble cette structure:</p>
<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="c1">// IPv4 AF_INET sockets:
</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="p">{</span>
    <span class="kt">short</span>            <span class="n">sin_family</span><span class="p">;</span>   <span class="c1">// AF_INET pour ipv4 et AF_INET6 pour ipv6
</span>    <span class="kt">unsigned</span> <span class="kt">short</span>   <span class="n">sin_port</span><span class="p">;</span>     <span class="c1">// port
</span>    <span class="k">struct</span> <span class="n">in_addr</span>   <span class="n">sin_addr</span><span class="p">;</span>     <span class="c1">// voir in_addr plus bas
</span>    <span class="kt">char</span>             <span class="n">sin_zero</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>  <span class="c1">// optionnel
</span><span class="p">};</span>
 
<span class="k">struct</span> <span class="n">in_addr</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">s_addr</span><span class="p">;</span>          <span class="c1">// load with inet_pton()
</span><span class="p">};</span>
 
<span class="k">struct</span> <span class="n">sockaddr</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">short</span>    <span class="n">sa_family</span><span class="p">;</span>    <span class="c1">// address family, AF_xxx
</span>    <span class="kt">char</span>              <span class="n">sa_data</span><span class="p">[</span><span class="mi">14</span><span class="p">];</span>  <span class="c1">// 14 bytes of protocol address
</span><span class="p">};</span>
</code></pre>
</div>
<p><code class="highlighter-rouge">sockaddr_in</code> possède un membre appelé <code class="highlighter-rouge">sin_addr</code> de type <code class="highlighter-rouge">in_addr</code> qui a un membre <code class="highlighter-rouge">s_adr</code> qui n’est rien d’autre qu’un <code class="highlighter-rouge">long</code>.</p>

<p>La fonction <code class="highlighter-rouge">inet_addr</code> est très pratique dans le sens où elle converti une adresse IP en un type long. Voici comment faire:</p>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="n">server</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">inet_addr</span><span class="p">(</span><span class="s">"74.125.235.20"</span><span class="p">);</span> <span class="c1">// ip de google
</span></code></pre>
</div>

<p>Il est donc nécéssaire de connaitre l’adress IP du serveur distant qu’on veut connecter.</p>

<p>La dernière chose dont on a besoin c’est de la fonction <code class="highlighter-rouge">connect</code> qui prend en paramètre un socket et la structure <code class="highlighter-rouge">sockaddr</code>.</p>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="cp">#include&lt;stdio.h&gt;
#include&lt;sys/socket.h&gt;
#include&lt;arpa/inet.h&gt; // inet_addr
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> 
<span class="p">{</span>
    <span class="c1">// variables
</span>    <span class="kt">int</span> <span class="n">socket_desc</span><span class="p">;</span>
    <span class="c1">// creation d'un objet de type sockaddr_in
</span>    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">server</span><span class="p">;</span>

    <span class="c1">// creation du socket -&gt; socket_desc
</span>    <span class="n">socket_desc</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">socket_desc</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> 
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Could not create socket"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// initialisation des membres de l'objet server
</span>    <span class="n">server</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">inet_addr</span><span class="p">(</span><span class="s">"172.217.22.78"</span><span class="p">);</span>
    <span class="n">server</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
    <span class="n">server</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">80</span><span class="p">);</span>

    <span class="c1">// connexion a un serveur distant
</span>    <span class="k">if</span> <span class="p">(</span><span class="n">connect</span><span class="p">(</span><span class="n">socket_desc</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span> <span class="p">)</span><span class="o">&amp;</span><span class="n">server</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">server</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"connect error"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">puts</span><span class="p">(</span><span class="s">"Connected"</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<p><span style="color:#F92672"><strong>Les connexions ne sont nécéssaires uniquement dans le cas du l’utilisation de TCP</strong></span></p>

<p>Le concepte de connexion ne s’applique que dans le cas de l’utilisation de SOCK_<strong>STREAM</strong> (socket <code class="highlighter-rouge">TCP</code>). Une connexion veut dire “reliable <em>stream</em> of data” de telle façon qu’on puisse avoir plusieurs de ces “stream” qui effectue chacun une communication.</p>

<blockquote>
  <p>think of this as a pipe which is not interfered by other data.</p>
</blockquote>

<p>D’autres sockets comme UDP, ICMP ou ARP par exemple n’ont pas besoin de se connecter. Se sont des protocoles non-orienté connexion.</p>

<h3 id="c-envoyer-des-données">c. Envoyer des données</h3>

<p>La fonction <code class="highlighter-rouge">send</code> nous permet d’envoyer des données. Elle a besoin en paramètre du descripteur de socket, la donnée à envoyer et sa taille.</p>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="cp">#include&lt;stdio.h&gt;
#include&lt;string.h&gt;
#include&lt;sys/socket.h&gt;
#include&lt;arpa/inet.h&gt; // inet_addr
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> 
<span class="p">{</span>
    <span class="c1">// variables
</span>    <span class="kt">int</span> <span class="n">socket_desc</span><span class="p">;</span>
    <span class="kt">char</span><span class="o">*</span> <span class="n">message</span><span class="p">;</span>
    <span class="c1">// creation d'un objet de type sockaddr_in
</span>    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">server</span><span class="p">;</span>

    <span class="c1">// creation du socket -&gt; socket_desc
</span>    <span class="n">socket_desc</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">socket_desc</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> 
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Could not create socket"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// initialisation des membres de l'objet server
</span>    <span class="n">server</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">inet_addr</span><span class="p">(</span><span class="s">"172.217.22.78"</span><span class="p">);</span>
    <span class="n">server</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
    <span class="n">server</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">80</span><span class="p">);</span>

    <span class="c1">// connexion a un serveur distant
</span>    <span class="k">if</span> <span class="p">(</span><span class="n">connect</span><span class="p">(</span><span class="n">socket_desc</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span> <span class="p">)</span><span class="o">&amp;</span><span class="n">server</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">server</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"connect error</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">puts</span><span class="p">(</span><span class="s">"Connected</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

    <span class="c1">// envoie de donnees 
</span>    <span class="n">message</span> <span class="o">=</span> <span class="s">"GET / HTTP/1.1</span><span class="se">\r\n\r\n</span><span class="s">"</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">send</span><span class="p">(</span><span class="n">socket_desc</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">message</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"Send failed</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">puts</span><span class="p">(</span><span class="s">"Data Send</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>
<p>Dans cette exemple, dans un premier temps nous nous connectons à l’adresse IP et ensuite envoyons notre chaîne de caractères. Ce message est une commande HTTP pour fetch la mainpage d’un site web.</p>

<p><a href=""><a href="/00illustrations/sockets/wireshark1.png"><img src="/00illustrations/sockets/wireshark1.png" /></a></a></p>

<p>Maintenant que nous avons envoyé des données, il faut faire en sorte de recevoir une réponse du serveur.</p>

<blockquote>
  <p>Quand on envoie des données à un socket, de façon similaire à écrire dans un fichier, nous écrivons dans le socket, par exemple nous pouvons utiliser la fonction <code class="highlighter-rouge">write</code> pour envoyer des données à un socket.</p>
</blockquote>

<h3 id="d-recevoir-des-données-sur-un-socket">d. Recevoir des données sur un socket.</h3>

<p>La fonction <code class="highlighter-rouge">recv</code> est utilisée pour recevoir des données sur un socket. Dans le prochain exemple, nous allons envoyer le même message quand dans le précédent exemple et recevoir une réponse du serveur.</p>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="cp">#include&lt;stdio.h&gt;
#include&lt;string.h&gt;
#include&lt;sys/socket.h&gt;
#include&lt;arpa/inet.h&gt; // inet_addr
#include&lt;unistd.h&gt; // close
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> 
<span class="p">{</span>
    <span class="c1">// variables
</span>    <span class="kt">int</span> <span class="n">socket_desc</span><span class="p">;</span>
    <span class="kt">char</span><span class="o">*</span> <span class="n">message</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">server_reply</span><span class="p">[</span><span class="mi">2000</span><span class="p">];</span>
    <span class="c1">// creation d'un objet de type sockaddr_in
</span>    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">server</span><span class="p">;</span>

    <span class="c1">// creation du socket -&gt; socket_desc
</span>    <span class="n">socket_desc</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">socket_desc</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> 
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Could not create socket"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// initialisation des membres de l'objet server
</span>    <span class="n">server</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">inet_addr</span><span class="p">(</span><span class="s">"172.217.22.78"</span><span class="p">);</span>
    <span class="n">server</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
    <span class="n">server</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">80</span><span class="p">);</span>

    <span class="c1">// connexion a un serveur distant
</span>    <span class="k">if</span> <span class="p">(</span><span class="n">connect</span><span class="p">(</span><span class="n">socket_desc</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span> <span class="p">)</span><span class="o">&amp;</span><span class="n">server</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">server</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"connect error</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">puts</span><span class="p">(</span><span class="s">"Connected</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

    <span class="c1">// envoie de donnees 
</span>    <span class="n">message</span> <span class="o">=</span> <span class="s">"GET / HTTP/1.1</span><span class="se">\r\n\r\n</span><span class="s">"</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">send</span><span class="p">(</span><span class="n">socket_desc</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">message</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"Send failed</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// recevoir une reponse du serveur
</span>    <span class="k">if</span> <span class="p">(</span><span class="n">recv</span><span class="p">(</span><span class="n">socket_desc</span><span class="p">,</span> <span class="n">server_reply</span><span class="p">,</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"recv failed"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">puts</span><span class="p">(</span><span class="s">"Reply received</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">puts</span><span class="p">(</span><span class="n">server_reply</span><span class="p">);</span>

    <span class="n">puts</span><span class="p">(</span><span class="s">"Data Send</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

    <span class="n">close</span><span class="p">(</span><span class="n">socket_desc</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>
<p>output:</p>
<div class="highlighter-rouge"><pre class="highlight"><code>Connected

Reply received

HTTP/1.1 302 Found
Cache-Control: private
Content-Type: text/html; charset=UTF-8
Referrer-Policy: no-referrer
Location: http://www.google.ch/?gfe_rd=cr&amp;ei=9oMsWbfPHJOT8QfFgK2IBg
Content-Length: 258
Date: Mon, 29 May 2017 20:26:30 GMT

&lt;HTML&gt;&lt;HEAD&gt;&lt;meta http-equiv="content-type" content="text/html;charset=utf-8"&gt;
&lt;TITLE&gt;302 Moved&lt;/TITLE&gt;&lt;/HEAD&gt;&lt;BODY&gt;
&lt;H1&gt;302 Moved&lt;/H1&gt;
The document has moved
&lt;A HREF="http://www.google.ch/?gfe_rd=cr&amp;amp;ei=9oMsWbfPHJOT8QfFgK2IBg"&gt;here&lt;/A&gt;.
&lt;/BODY&gt;&lt;/HTML&gt;

Data Send
</code></pre>
</div>

<p>Nous voyons ici la réponse de google qui nous envoie le contenu de la page demandé.</p>

<blockquote>
  <p>Quand nous recevons des données sur un socket, nous lisons les données dans le socket comme nous le ferions pour un simple fichier. Nous pourions utiliser la fonction <code class="highlighter-rouge">read</code> pour lire des données sur un socket.<br />
<code class="highlighter-rouge">read(socket_desc, server_reply, 2000);</code></p>
</blockquote>

<p>Maintenant que nous avons reçu notre réponse, nous pouvons fermer le socket (<em>fichier</em>).</p>

<h3 id="e-fermeture-de-socket">e. Fermeture de socket</h3>

<p>Je ne l’ai pas dit dans le précédent exemple mais j’ai également ajouter la fonction <code class="highlighter-rouge">close</code> qui vit dans le header <code class="highlighter-rouge">&lt;unistd.h&gt;</code> a la fin de notre main.</p>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="n">close</span><span class="p">(</span><span class="n">socket_desc</span><span class="p">)</span>
</code></pre>
</div>

<p>Voici une capture wireshark de l’échange:</p>

<p><a href=""><a href="/00illustrations/sockets/wireshark2.png"><img src="/00illustrations/sockets/wireshark2.png" /></a></a></p>

<h3 id="f-récapitulatif">f. Récapitulatif</h3>

<ol>
  <li>Création d’un socket</li>
  <li>Connexion à un serveur distant</li>
  <li>Envoie de données</li>
  <li>Réception de données</li>
  <li>Fermeture du socket</li>
</ol>

<p>C’est exactement ce que fait notre navigateur quand nous ouvrons la page www.google.com
Ce genre d’utilisation d’un socket est appelé <strong>socket client</strong>.</p>

<blockquote>
  <p>Un client est une application qui se connecte sur un serveur pour y fetcher des données.</p>
</blockquote>

<p>L’autre genre d’application socket sont donc naturellement les <strong>sockets serveurs</strong>. Un serveur est un système qui utilise des sockets pour recevoir des connexions et fournir des données par ce biais.</p>

<p>Dans notre exemple www.google.com est un serveur HTTP et notre navigateur est client HTTP.</p>

<p>Avant de faire notre propre serveur, nous allons passer par quelques explications d’ordre général sur la programmation de sockets.</p>

<h1 id="6-trouver-lip-dun-domaine">6. Trouver l’ip d’un domaine</h1>

<p>Quand on se connecte à un hôte distant, il est nécéssaire d’avoir son adresse IP. C’est là que la fonction <code class="highlighter-rouge">gethostbyname</code> nous est utile. Elle prend un nom de domaine comme paramètre et retourne une structure de type <code class="highlighter-rouge">hostent</code> et contient l’IP que l’on cherche. <code class="highlighter-rouge">gethostbynam</code> vit dans le header <code class="highlighter-rouge">&lt;netdb.h&gt;</code>.</p>

<p>Voici cette structure:</p>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="k">struct</span> <span class="n">hostent</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">h_name</span><span class="p">;</span>         <span class="c1">// Official name of host.
</span>  <span class="kt">char</span> <span class="o">**</span><span class="n">h_aliases</span><span class="p">;</span>     <span class="c1">// Alias list.  
</span>  <span class="kt">int</span> <span class="n">h_addrtype</span><span class="p">;</span>       <span class="c1">// Host address type.  
</span>  <span class="kt">int</span> <span class="n">h_length</span><span class="p">;</span>         <span class="c1">// Length of address.  
</span>  <span class="kt">char</span> <span class="o">**</span><span class="n">h_addr_list</span><span class="p">;</span>   <span class="c1">// List of addresses from name server.
</span><span class="p">};</span>
</code></pre>
</div>
<p>h_addr_list contient les adresses pour joindre notre hôte.</p>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="cp">#include&lt;stdio.h&gt; //printf
#include&lt;string.h&gt; //strcpy
#include&lt;sys/socket.h&gt;
#include&lt;netdb.h&gt; //hostent
#include&lt;arpa/inet.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">hostname</span> <span class="o">=</span> <span class="s">"www.google.com"</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">ip</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
    <span class="k">struct</span> <span class="n">hostent</span> <span class="o">*</span><span class="n">he</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">in_addr</span> <span class="o">**</span><span class="n">addr_list</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">he</span> <span class="o">=</span> <span class="n">gethostbyname</span><span class="p">(</span><span class="n">hostname</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">herror</span><span class="p">(</span><span class="s">"gethostbyname"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">addr_list</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">in_addr</span> <span class="o">**</span> <span class="p">)</span><span class="n">he</span><span class="o">-&gt;</span><span class="n">h_addr_list</span><span class="p">;</span>

    <span class="n">strcpy</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">inet_ntoa</span><span class="p">(</span><span class="o">*</span><span class="n">addr_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
    
    <span class="n">printf</span><span class="p">(</span><span class="s">"%s resolved to : %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">hostname</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<p>output:</p>
<div class="highlighter-rouge"><pre class="highlight"><code>www.google.com resolved to : 216.58.205.164
</code></pre>
</div>

<p>Cette fonction très pratique nous permet de résoudre un nom de domaine en adresse IP et ensuite nous pouvons utiliser l’adresse IP pour créér une connexion à l’aide d’un Socket.</p>

<p>La fonction <code class="highlighter-rouge">inet_ntoa</code> converti une adresse IP stoquée dans un long (type) en notation à point.</p>

<h3 id="récapitulatif-des-structures">Récapitulatif des structures</h3>

<p>Nous avons vu quelques structure importantes qui reviennent tout le temps dans le domaine de la progrmtion de sockets:</p>

<ol>
  <li><code class="highlighter-rouge">sockaddr_in</code> : information de connexion principalement utilisées par les fonctions <code class="highlighter-rouge">connect</code>, <code class="highlighter-rouge">send</code>, <code class="highlighter-rouge">recv</code></li>
  <li><code class="highlighter-rouge">in_addr</code> : adresse IP au format long (type)</li>
  <li>sockaddr : informations sur le socket</li>
  <li><code class="highlighter-rouge">hostent</code> : l’IP de l’hôte utilisé par la fonction <code class="highlighter-rouge">gethostbyname</code></li>
</ol>

<h2 id="7-serveur-http">7. Serveur HTTP</h2>

<h3 id="a-cycle-de-vie">a. cycle de vie</h3>

<p>Passons à un serveur. Les <strong>sockets serveur</strong> fonctionne de la façon suivante:</p>

<ol>
  <li>création d’un socket</li>
  <li>bind (lie) du socket à une adresse(et un port)</li>
  <li>écoute du port en attente d’une connexion</li>
  <li>acceptation de la connexion</li>
  <li>lecture/envoi</li>
</ol>

<h3 id="b-implémentation">b. implémentation</h3>

<p>Nous savons déja comment créer un socket donc nous allons directement passer à la seconde étape.</p>

<p>La fonction <code class="highlighter-rouge">bind</code> sert à lier un socket à un couple adresse port spécifique. Tout comme la fonction <code class="highlighter-rouge">connect</code> elle a besoin d’une structure <code class="highlighter-rouge">sockaddr_in</code>.</p>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="cp">#include&lt;stdio.h&gt;
#include&lt;sys/socket.h&gt;
#include&lt;arpa/inet.h&gt; // inet_addr
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// variables
</span>    <span class="kt">int</span> <span class="n">socket_desc</span><span class="p">,</span> <span class="n">new_socket</span><span class="p">,</span> <span class="n">c</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">server</span><span class="p">,</span> <span class="n">client</span><span class="p">;</span>

    <span class="c1">// creation de socket
</span>    <span class="n">socket_desc</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">socket_desc</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Could not create socket</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// initialisation des membres de l'objet server
</span>    <span class="n">server</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
    <span class="n">server</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">INADDR_ANY</span><span class="p">;</span>
    <span class="n">server</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span> <span class="p">(</span><span class="mi">8888</span><span class="p">);</span>

    <span class="c1">// bind
</span>    <span class="k">if</span> <span class="p">(</span><span class="n">bind</span><span class="p">(</span><span class="n">socket_desc</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span> <span class="p">)</span><span class="o">&amp;</span><span class="n">server</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">server</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">bind failded</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">bind done</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

    <span class="c1">// ecoute
</span>    <span class="n">listen</span><span class="p">(</span><span class="n">socket_desc</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

    <span class="c1">// Accept incoming connection
</span>    <span class="n">puts</span><span class="p">(</span><span class="s">"Waiting for incoming connections...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">c</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span><span class="p">);</span>
    <span class="n">new_socket</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">socket_desc</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span> <span class="p">)</span><span class="o">&amp;</span><span class="n">client</span><span class="p">,</span> <span class="p">(</span><span class="n">socklen_t</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">c</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">new_socket</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"accept failed</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">puts</span><span class="p">(</span><span class="s">"Connection accepted</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>
<p>On lance le programme dans un premier terminal:</p>
<div class="language-sh highlighter-rouge"><pre class="highlight"><code><span class="gp">sol@debian:~/code/sockets/serveurHTTP$ </span>./serveur

<span class="nb">bind </span><span class="k">done

</span>Waiting <span class="k">for </span>incoming connections...
</code></pre>
</div>

<p>dans un second terminal on lancer un <code class="highlighter-rouge">telnet localhost 888</code>:</p>

<div class="language-sh highlighter-rouge"><pre class="highlight"><code><span class="gp">sol@debian:~/LABOS/labo5/03Trace$ </span>telnet localhost 8888
Trying ::1...
Trying 127.0.0.1...
Connected to localhost.
Escape character is <span class="s1">'^]'</span>.
Connection closed by foreign host.
</code></pre>
</div>

<p>Dans le premier terminal un nouveau message apparait avant de nous rendre le prompt:</p>

<div class="language-sh highlighter-rouge"><pre class="highlight"><code><span class="gp">sol@debian:~/code/sockets/serveurHTTP$ </span>./serveur

<span class="nb">bind </span><span class="k">done

</span>Waiting <span class="k">for </span>incoming connections...

Connection accepted
sol@debian:~/code/sockets/serveurHTTP<span class="err">$</span>
</code></pre>
</div>

<p><a href=""><a href="/00illustrations/sockets/wireshark3.png"><img src="/00illustrations/sockets/wireshark3.png" /></a></a></p>

<h3 id="c-ip-et-port-du-client-qui-se-connecte">c. IP et port du client qui se connecte</h3>

<p>Pour avoir l’IP du client et le port de connexion en utilisant les informations de la structure <code class="highlighter-rouge">sockaddr_in</code> qu’on a passé en argument de la fonction <code class="highlighter-rouge">accept</code>:</p>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="kt">char</span> <span class="o">*</span><span class="n">client_ip</span> <span class="o">=</span> <span class="n">inet_ntoa</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">client_port</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">sin_port</span><span class="p">);</span>
</code></pre>
</div>

<h3 id="d-rendre-tout-ça-plus-productif">d. rendre tout ça plus productif</h3>

<p>Dans cet exemple nous acceptons une connexion mais la refermons directement. Ce n’est pas très interessant.</p>

<p>Répondons donc quelque chose au client qui se connecte à nous dire faire genre on est pas totalement innutile.</p>

<p>On peut utiliser la fonction <code class="highlighter-rouge">write</code> pour écire qqch dans le socket qui se connecte à nous et le client devrait le voir.</p>

<p>Il suffit d’ajouter ce bout de code à la fin de notre main en prenant soins d’ajouter les header <code class="highlighter-rouge">&lt;string.h&gt;</code> et <code class="highlighter-rouge">&lt;unistd.h&gt;</code></p>

<div class="language-c highlighter-rouge"><pre class="highlight"><code>    <span class="c1">// repond au client
</span>    <span class="kt">char</span> <span class="o">*</span><span class="n">message</span> <span class="o">=</span> <span class="s">"Salut client, je te sens bien en moi mais k thx bye!</span><span class="se">\n</span><span class="s">."</span><span class="p">;</span>
    <span class="n">write</span><span class="p">(</span><span class="n">new_socket</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">message</span><span class="p">));</span>
</code></pre>
</div>

<p>Sur son terminal, le client verra:</p>

<div class="language-sh highlighter-rouge"><pre class="highlight"><code><span class="gp">sol@debian:~/LABOS/labo5/03Trace$ </span>telnet localhost 8888
Trying ::1...
Trying 127.0.0.1...
Connected to localhost.
Escape character is <span class="s1">'^]'</span>.
Salut client, je te sens bien en moi mais k thx bye!
.Connection closed by foreign host.
</code></pre>
</div>

<h2 id="4-serveur-live-multiprocessus">4. Serveur live (multiprocessus)</h2>

<p>Notre serveur coupe la connexion directement après avoir envoyé sa réponse. Un serveur comme google.com est toujours à l’écoute de nouvelles connexions entrantes.</p>

<p>Celà veut dire que ce serveur est sensé tourner et accepter des connexions non-stop. Pour y arriver, la façon la plus facile est de mettre la fonction <code class="highlighter-rouge">accept</code> dans une boucle.</p>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="cp">#include&lt;stdio.h&gt;
#include&lt;string.h&gt;    //strlen
#include&lt;sys/socket.h&gt;
#include&lt;arpa/inet.h&gt; //inet_addr
#include&lt;unistd.h&gt;    //write
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// variables
</span>    <span class="kt">int</span> <span class="n">socket_desc</span><span class="p">,</span> <span class="n">new_socket</span><span class="p">,</span> <span class="n">c</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">server</span><span class="p">,</span> <span class="n">client</span><span class="p">;</span>
    <span class="kt">char</span><span class="o">*</span> <span class="n">message</span><span class="p">;</span>

    <span class="c1">// creation de socket
</span>    <span class="n">socket_desc</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">socket_desc</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Could not create socket</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// initialisation des membres de l'objet server
</span>    <span class="n">server</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
    <span class="n">server</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">INADDR_ANY</span><span class="p">;</span>
    <span class="n">server</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span> <span class="p">(</span><span class="mi">8888</span><span class="p">);</span>

    <span class="c1">// bind
</span>    <span class="k">if</span> <span class="p">(</span><span class="n">bind</span><span class="p">(</span><span class="n">socket_desc</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span> <span class="p">)</span><span class="o">&amp;</span><span class="n">server</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">server</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">bind failded</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">bind done</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

    <span class="c1">// ecoute
</span>    <span class="n">listen</span><span class="p">(</span><span class="n">socket_desc</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

    <span class="c1">// Accepte les connexions
</span>    <span class="n">puts</span><span class="p">(</span><span class="s">"Waiting for incoming connections...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">c</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span><span class="p">);</span>

    <span class="k">while</span> <span class="p">(</span> <span class="p">(</span><span class="n">new_socket</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">socket_desc</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span> <span class="p">)</span><span class="o">&amp;</span><span class="n">client</span><span class="p">,</span> <span class="p">(</span><span class="n">socklen_t</span> <span class="o">*</span> <span class="p">)</span><span class="o">&amp;</span><span class="n">c</span><span class="p">))</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// affiche les infos du client
</span>        <span class="n">printf</span><span class="p">(</span><span class="s">"Connection from %s:%d accepted</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">inet_ntoa</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">),</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">sin_port</span><span class="p">));</span>

        <span class="c1">// repond au client
</span>        <span class="n">message</span> <span class="o">=</span> <span class="s">"Salut client, je te sens bien en moi mais k thx bye!</span><span class="se">\n</span><span class="s">."</span><span class="p">;</span>
        <span class="n">write</span><span class="p">(</span><span class="n">new_socket</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">message</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">new_socket</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"accept failed</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<p><a href=""><a href="/00illustrations/sockets/wireshark4.png"><img src="/00illustrations/sockets/wireshark4.png" /></a></a></p>

<p>En décortiquant le screenshot, nous pouvons voir que le Serveur tourne en permanance et accepte toutes les connexions telnet qu’on lui propose. Une fois qu’on coupe le serveur, les 3 connexions cessent automatiquement (logique).</p>

<h1 id="5-serveur-tcp-de-base-avec-fork-des-process-enfants">5. Serveur TCP de base avec fork() des process enfants</h1>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="cp">#include&lt;sys/socket.h&gt;
#include&lt;stdio.h&gt;
#include&lt;stdlib.h&gt;
#include&lt;string.h&gt;      // strlen
#include&lt;arpa/inet.h&gt;   // inet_addr
#include&lt;unistd.h&gt;      // write
</span>
<span class="kt">void</span> <span class="n">childProcess</span><span class="p">(</span><span class="kt">int</span> <span class="n">sock</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">socket_desc</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">new_socket</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">pid</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">server</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">client</span><span class="p">;</span>

    <span class="c1">// creation du socket
</span>    <span class="n">socket_desc</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">socket_desc</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"ERROR opening socket"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// initialisation des membres de l'objet server
</span>    <span class="n">server</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
    <span class="n">server</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">INADDR_ANY</span><span class="p">;</span>
    <span class="n">server</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">8888</span><span class="p">);</span>

    <span class="c1">// bind
</span>    <span class="k">if</span> <span class="p">(</span><span class="n">bind</span><span class="p">(</span><span class="n">socket_desc</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span> <span class="p">)</span><span class="o">&amp;</span><span class="n">server</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">server</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"ERROR on binding"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">bind done</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

    <span class="c1">// sleep mode en attendant un client
</span>    <span class="n">listen</span><span class="p">(</span><span class="n">socket_desc</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">waiting for incoming connections...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

    <span class="n">n</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span><span class="p">);</span>

    <span class="c1">// boucle infinie qui accepte et fork les clients distant
</span>    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">new_socket</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">socket_desc</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">client</span><span class="p">,</span> <span class="p">(</span><span class="n">socklen_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">new_socket</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">perror</span><span class="p">(</span><span class="s">"ERROR on accept"</span><span class="p">);</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// affiche les infos du client
</span>        <span class="n">printf</span><span class="p">(</span><span class="s">"Connection from %s:%d accepted</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> 
            <span class="n">inet_ntoa</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">),</span> <span class="c1">// conversion adr en un format Inet Std dot Ntation (str)
</span>            <span class="n">ntohs</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">sin_port</span><span class="p">));</span> <span class="c1">// conversion Network Byte Order vers Host Byte Order (endianess)
</span>            
        <span class="c1">// creation process enfant
</span>        <span class="n">pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">();</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">perror</span><span class="p">(</span><span class="s">"ERROR on fork"</span><span class="p">);</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// processus du client
</span>            <span class="n">close</span><span class="p">(</span><span class="n">socket_desc</span><span class="p">);</span>
            <span class="n">childProcess</span><span class="p">(</span><span class="n">new_socket</span><span class="p">);</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="n">close</span><span class="p">(</span><span class="n">new_socket</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">childProcess</span><span class="p">(</span><span class="kt">int</span> <span class="n">sock</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
    <span class="n">bzero</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="mi">256</span><span class="p">);</span>

    <span class="c1">// lecture du message du client
</span>    <span class="n">n</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"ERROR reading from socket</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// affichage message client
</span>    <span class="n">printf</span><span class="p">(</span><span class="s">"Message from client: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>

    <span class="c1">// ecrit une reponse au client
</span>    <span class="n">n</span> <span class="o">=</span> <span class="n">write</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="s">"ok"</span><span class="p">,</span> <span class="mi">18</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"ERROR reading from socket"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<h1 id="6-client-tcp-basique">6. client TCP basique</h1>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="cp">#include&lt;stdio.h&gt;
#include&lt;stdlib.h&gt;
#include&lt;netdb.h&gt;
#include&lt;unistd.h&gt;
#include&lt;string.h&gt;
</span>

<span class="kt">int</span> <span class="nf">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">socket_desc</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">portno</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">server_addr</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">hostent</span> <span class="o">*</span><span class="n">server</span><span class="p">;</span>

    <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"usage %s hostname port</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">portno</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

    <span class="c1">// creation socket
</span>    <span class="n">socket_desc</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">socket_desc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"ERROR opening socket"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">server</span> <span class="o">=</span> <span class="n">gethostbyname</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">server</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"ERROR, no such host</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">bzero</span><span class="p">((</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">server_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">server_addr</span><span class="p">));</span>
    <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
    <span class="n">bcopy</span><span class="p">((</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">h_addr</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">server_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">,</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">h_length</span><span class="p">);</span>
    <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">portno</span><span class="p">);</span>

    <span class="c1">// connexion au serveur
</span>    <span class="k">if</span> <span class="p">(</span><span class="n">connect</span><span class="p">(</span><span class="n">socket_desc</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span><span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">server_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">server_addr</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"ERROR connecting"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// demande a l'utilisateur d'ecrire un message qui sera affiche chez le serveur
</span>    <span class="n">printf</span><span class="p">(</span><span class="s">"Please enter a message: "</span><span class="p">);</span>
    <span class="n">bzero</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="mi">256</span><span class="p">);</span>
    <span class="n">fgets</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="n">stdin</span><span class="p">);</span>

    <span class="c1">// envoie du message
</span>    <span class="n">n</span> <span class="o">=</span> <span class="n">write</span><span class="p">(</span><span class="n">socket_desc</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"ERROR reading from socket"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

</div>

<div>
	
	<div class="tbc"></div>
	
</div>

<!--<div class="share">
    <p>Share this post with: </p>
	<a href="https://twitter.com/intent/tweet?text=Reseau: Programmation sockets (tuto)@&amp;url=http://localhost:4000/reseau/reseau-programmation-sockets.html" class="twitter-share">
		<span class="fa-stack fa-lg">
			<i class="fa fa-circle fa-stack-2x"></i>
			<i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
		</span>
	</a>
    
	<a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/reseau/reseau-programmation-sockets.html" class="facebook-share">
		<span class="fa-stack fa-lg">
			<i class="fa fa-circle fa-stack-2x"></i>
			<i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
		</span>
	</a>
    
	<a href="https://plus.google.com/share?url=http://localhost:4000/reseau/reseau-programmation-sockets.html" class="googleplus-share">
		<span class="fa-stack fa-lg">
			<i class="fa fa-circle fa-stack-2x"></i>
			<i class="fa fa-google-plus fa-stack-1x fa-inverse"></i>
		</span>
	</a>
</div>
-->

<div id="disqus_thread"></div>


 
</div>


</article>

        </div>

    </body>

<footer class="site-footer">
    <div class="wrapper">
        <center>
            <p>
                <a class="link" href="/%20/">Home</a> /
                <a class="link" href="/archive/">Archive</a> /
                <a class="link" href="/category/">Category</a> /
                <a class="link" href="/tags/">Tags</a> /
                <a class="link" href="/about/">About</a> /
                <a class="link" href="/contact/">Contact</a>
            </p>
            <span><script>document.write(new Date().getFullYear());</script></span>
            <span>&copy;</span>

            <a href="mailto:sol.rosca@gmail.com?subject=Hello&nbsp;RoscaS"> RoscaS</a>
            <br>
        </center>
    </div>
</footer>

<foot>
    <foot>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Derictory -->

  <script src="http://code.jquery.com/jquery-1.7.2.min.js"></script>
  <script src="http://yandex.st/highlightjs/6.2/highlight.min.js"></script>

<!-- Hit analytics -->

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<!-- Directory -->

<script src="/js/main.js"></script>

</foot>

</foot>

</html>
